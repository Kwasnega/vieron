<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/x-icon" href="gctu.ico" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUEUEUP Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 0;
      background: #f0f2f5; color: #1f2937;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh; overflow-x: hidden;
    }
    .container {
      background: white; border-radius: 20px;
      width: 92%; max-width: 1100px; min-height: 90vh;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; padding: 28px; position: relative;
    }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding:10px 20px; }
    .logo-container { display:flex; align-items:center; gap: 8px; }
    .logo-image { height: 40px; }
    .logo-text { font-weight:600; font-size:1.1rem; }
    .logo-text small { display:block; font-weight:400; font-size:0.85rem; color:#6b7280; }
    .icon-group { display:flex; align-items:center; gap: 8px; }
    .btn-profile { background:#f3f4f6; border-radius:50%; width:56px; height:56px; display:flex; justify-content:center; align-items:center; border:none; cursor:pointer; }
    .btn-logout { background:#e05656; color:#fff; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }

    .notification-container { position: relative; }
    .notification-bell { cursor: pointer; color: #4b5563; transition: color 0.2s; }
    .notification-count { position: absolute; top: -5px; right: -5px; background: #e05656; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: bold; }
    .bell-active { color: #e05656 !important; }

    .section-card { background:#fff; border-radius:12px; padding:20px; margin-bottom:18px; box-shadow:0 4px 12px rgba(0,0,0,0.06); border:1px solid #e5e7eb; }
    .profile-card { display:flex; align-items:center; gap:14px; }
    .profile-card .icon { width:48px; height:48px; border-radius:50%; background:#f3f4f6; display:flex; justify-content:center; align-items:center; }
    .profile-card h3 { margin:0; font-weight:600; }
    .profile-card p { margin:0; color:#6b7280; }

    .cards-grid { display:flex; gap:18px; flex-wrap:wrap; justify-content:flex-start; }
    .card { background:#f9fafb; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,0.05); cursor:pointer; transition:transform .12s, box-shadow .2s; min-width:220px; border:1px solid #e5e7eb; }
    .card:hover { transform:translateY(-4px); box-shadow:0 12px 24px rgba(0,0,0,0.1); }
    .card .icon-circle { width:48px; height:48px; background:#eef2ff; border-radius:50%; display:flex; justify-content:center; align-items:center; margin-bottom:8px; }
    .card h3 { margin:6px 0 0 0; font-size:1rem; font-weight:600; }
    .card p { color:#6b7280; font-size:0.85rem; margin-top:6px; }

    .divider { border-top:1px solid #e5e7eb; margin:18px 0; }

    /* Modals */
    .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.45); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal { width:100%; max-width:720px; background:#fff; border-radius:12px; padding:20px; box-shadow:0 20px 40px rgba(0,0,0,0.2); transform: translateY(12px); max-height: 90vh; display: flex; flex-direction: column;}
    .modal-content { overflow-y: auto; padding-right: 15px; }
    .modal header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .close-btn { background:#e5e7eb; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
    .form label { display:block; margin:10px 0 6px 0; color:#4b5563; font-weight:600; }
    .form input, .form select, .form textarea { width:100%; padding:12px; border-radius:8px; border:1px solid #e5e7eb; background:#f9fafb; resize:vertical; box-sizing:border-box; }
    .form textarea { min-height:120px; }
    .primary { background:#5596ff; color:white; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; margin-top:12px; font-weight:700; }
    .primary.loading { opacity:0.7; pointer-events:none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;margin-right:8px;vertical-align:middle;animation:spin .9s linear infinite; }

    /* Lists */
    ul { list-style:none; padding:0; margin:0; max-width:100%; }
    li.item { background:#f9fafb; border-radius:8px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; border:1px solid #e5e7eb; }
    .item-left { max-width:78%; }
    .meta { color:#8b919d; font-size:0.9rem; margin-top:6px; }
    .status-pill { padding:6px 10px; border-radius:999px; font-weight:700; font-size:0.85rem; white-space:nowrap; }
    .s-Queued { background:#bfdbfe; color:#1e3a8a; cursor:pointer; transition: all 0.2s; }
    .s-In\ Progress { background:#fef3c7; color:#713f12; cursor:pointer; transition: all 0.2s; }
    .s-Resolved { background:#dcfce7; color:#14532d; cursor:pointer; transition: all 0.2s; }
    .s-Closed { background:#e5e7eb; color:#374151; cursor:pointer; transition: all 0.2s; }
    .s-inactive { background:#f3f4f6; color:#6b7280; cursor:pointer; transition: all 0.2s; }
    
    .status-pill:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    
    /* Progress Modal Styles */
    .progress-timeline { margin: 16px 0; }
    .timeline-item { display: flex; align-items: flex-start; margin-bottom: 16px; padding: 12px; border-radius: 8px; background: #f9fafb; border-left: 4px solid #e5e7eb; }
    .timeline-item.current { background: #eef2ff; border-left-color: #5596ff; }
    .timeline-item.completed { background: #f0fdf4; border-left-color: #22c55e; }
    .timeline-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 12px; margin-top: 4px; flex-shrink: 0; }
    .timeline-dot.pending { background: #d1d5db; }
    .timeline-dot.current { background: #5596ff; }
    .timeline-dot.completed { background: #22c55e; }
    .timeline-content h4 { margin: 0 0 4px 0; font-size: 0.9rem; font-weight: 600; }
    .timeline-content p { margin: 0; font-size: 0.85rem; color: #6b7280; }
    .timeline-content .timestamp { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; }

    /* Toasts */
    .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display:flex; flex-direction:column; gap:10px; }
    .toast { padding:12px 20px; border-radius:8px; color:#fff; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.2); opacity:0; transform: translateY(8px); transition: all 260ms ease; }
    .toast.show { opacity:1; transform: translateY(0); }
    .toast.success { background:#28a745; } .toast.error { background:#dc3545; } .toast.info { background:#17a2b8; }

    /* small helpers */
    .muted { color:#6b7280; font-size:0.95rem; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px; }
    .info-grid div { display: flex; flex-direction: column; }
    .label { font-weight: 600; font-size: 0.85rem; color: #4b5563; }

    @media (max-width:800px){
      .cards-grid { justify-content:center; }
      .modal { margin: 0 10px; }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>

  <div class="container">
    <header>
      <div class="logo-container">
        <img src="gctu.png" alt="GCTU Logo" class="logo-image">
        <div class="logo-text">Ghana Communication <small>Technology University (GCTU)</small></div>
      </div>

      <div class="icon-group">
        <button id="profileCardLink" class="btn-profile" title="Edit Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="28" height="28"><path d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0zM3.75 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.94.085 6.75 6.75 0 0 0-14.62 0 .75.75 0 0 1-.94-.085z"/></svg>
        </button>

        <div class="notification-container" title="Notifications">
          <svg class="notification-bell" id="notificationBell" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M14.5 6.2a1.5 1.5 0 0 1-3 0 1.5 1.5 0 0 1 3 0Z" />
            <path fill-rule="evenodd" d="M12 2.25A6 6 0 0 0 6 8v3.684l-1.928 2.314a.75.75 0 0 0 1.054 1.115l.412-.383a.5 5 0 0 0 .154-.423v-1.127a6.742 6.742 0 0 1 2.572-5.266A4.5 4.5 0 0 1 12 5.25a4.5 4.5 0 0 1 4.5 4.5v1.127a.5 5 0 0 0 .154.423l.412.383a.75.75 0 0 0 1.054-1.115L18 11.684V8a6 6 0 0 0-6-6Zm2.25 15c.666 0 1.318-.112 1.936-.334a7.514 7.514 0 0 0 4.093-3.664.75.75 0 0 0-.798-1.077 5.964 5.964 0 0 1-3.681 2.404c-.183.045-.369.07-.55.071H9.75a6.002 6.002 0 0 1-6-6v-2.25c0-.414.336-.75.75-.75S2.25 8.636 2.25 9v2.25a7.502 7.502 0 0 0 7.5 7.5h4.5ZM12 21.75a2.25 2.25 0 0 1-2.25-2.25h4.5A2.25 2.25 0 0 1 12 21.75Z" clip-rule="evenodd" />
          </svg>
          <span id="notificationCount" class="notification-count" style="display:none;">0</span>
        </div>

        <button id="logoutBtn" class="btn-logout" title="Log out">Log out</button>
      </div>
    </header>

    <section id="mainScreen" class="section-card">
      <div class="profile-card">
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="28" height="28"><path d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0zM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.941.085 6.75 6.75 0 0 0-14.616 0 .75.75 0 0 1-.941-.085Z"/></svg>
        </div>
        <div>
          <h3 id="studentNameDisplay">Loading name...</h3>
          <p id="studentIdDisplay">Loading student ID...</p>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-card academic-card">
        <h3>Academic Information</h3>
        <div class="info-grid">
          <div><span class="label">Student ID</span><span id="s-studentId"></span></div>
          <div><span class="label">Faculty</span><span id="s-faculty"></span></div>
          <div><span class="label">Group</span><span id="s-department"></span></div>
          <div><span class="label">Programme</span><span id="s-programme"></span></div>
          <div><span class="label">Level</span><span id="s-level"></span></div>
          <div><span class="label">Semester</span><span id="s-semester"></span></div>
          <div><span class="label">Session</span><span id="s-session"></span></div>
        </div>
      </div>

      <div class="cards-grid" style="margin-top:12px;">
        <div id="resultsCard" class="card" role="button" tabindex="0" title="Report a problem with your academic results">
          <div class="icon-circle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M9 2.25a2.25 2.25 0 0 1 4.5 0h3.75A2.25 2.25 0 0 1 19.5 4.5v15a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5v-15A2.25 2.25 0 0 1 6.75 2.25H9z"/></svg>
          </div>
          <h3>Report Results Issue</h3>
          <p class="muted">Report missing or incorrect grades</p>
        </div>

        <div id="complaintCard" class="card" role="button" tabindex="0" title="Make a general complaint">
          <div class="icon-circle">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M2.25 8.67v8.58a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3V8.67"/></svg>
          </div>
          <h3>Make a Complaint</h3>
          <p class="muted">Report any non-academic issues</p>
        </div>

        <div id="trackComplaintsCard" class="card" role="button" tabindex="0" title="View status of your complaints">
          <div class="icon-circle">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5"/></svg>
          </div>
          <h3>Track Complaint</h3>
          <p class="muted">See progress on your submitted complaints</p>
        </div>

        <div id="trackResultsCard" class="card" role="button" tabindex="0" title="View status of your results issues">
          <div class="icon-circle">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5"/></svg>
          </div>
          <h3>Track Results Issue</h3>
          <p class="muted">See progress on reported results issues</p>
        </div>
      </div>
    </section>
  </div>

  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get,
      child,
      update,
      off
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /*********** Replace these with your firebase project config ***********/
    const firebaseConfig = {
      apiKey: "AIzaSyDIqR0b9hA9IaLhRsVtJKSSwh9NktuIIjI",
      authDomain: "queueup-85662.firebaseapp.com",
      databaseURL: "https://queueup-85662-default-rtdb.firebaseio.com",
      projectId: "queueup-85662",
      storageBucket: "queueup-85662.firebasestorage.app",
      messagingSenderId: "647901471109",
      appId: "1:647901471109:web:2607f4883cd1393259e4ec"
    };
    /************************************************************************/

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI elements
    const studentNameDisplay = document.getElementById('studentNameDisplay');
    const studentIdDisplay = document.getElementById('studentIdDisplay');
    const logoutBtn = document.getElementById('logoutBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    const toastContainer = document.getElementById('toast-container');
    const profileCardLink = document.getElementById('profileCardLink');
    const notificationBell = document.getElementById('notificationBell');
    const notificationCount = document.getElementById('notificationCount');

    // State
    let currentUID = null;
    let profile = null; // will hold {studentId, email, full_name, department, ...}
    let complaintsListenerRef = null;
    let resultsListenerRef = null;
    let notificationsListenerRef = null;

    const facultyProgrammes = {
      "Faculty of Computing & Information Systems (FoCIS)": [
        "BSc Information Technology", "BSc Mobile Computing", "BSc Information Systems",
        "BSc Computer Science", "BSc Computer Science (Cybersecurity option)", "BSc Data Science and Analytics",
        "BSc Network and Systems", "BSc Software Engineering", "BSc Internet of Things and Big Data"
      ],
      "Faculty of Engineering (FoE)": [
        "BSc Telecommunications Engineering", "BSc Computer Engineering", "BSc Electrical & Electronic Engineering",
        "BSc Mathematics", "Diploma in Telecommunications Engineering"
      ],
      "GCTU Business School": [
        "BSc Accounting with Computing", "BSc Economics", "BSc Procurement and Logistics",
        "BSc Banking and Finance", "BSc E-Commerce & Marketing Management",
        "BSc Business Administration with options in HRM, Marketing, Accounting, Management",
        "Diploma in Public Relations", "Diploma in Management", "Diploma in Accounting option", "Diploma in Marketing option"
      ]
    };

    /********************** UI helpers **********************/
    function showToast(message, type='info') {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.textContent = message;
      toastContainer.appendChild(t);
      setTimeout(()=> t.classList.add('show'), 20);
      setTimeout(()=> { t.classList.remove('show'); t.addEventListener('transitionend', ()=> t.remove()); }, 3500);
    }

    function openModal(htmlContent) {
      modalContent.innerHTML = htmlContent;
      modalBackdrop.style.display = 'flex';
      document.body.style.overflow = 'hidden';   // ðŸ”’ stop background scroll
      modalBackdrop.setAttribute('aria-hidden', 'false');
      // attach close handler on backdrop click (but not inside modal)
      setTimeout(() => {
        // click outside content closes
        modalBackdrop.addEventListener('click', backdropClickHandler);
      }, 50);
    }
    function backdropClickHandler(e) {
      if (e.target === modalBackdrop) closeModal();
    }
    function closeModal() {
      modalBackdrop.style.display = 'none';
      document.body.style.overflow = '';
      modalBackdrop.setAttribute('aria-hidden', 'true');
      modalContent.innerHTML = '';
      modalBackdrop.removeEventListener('click', backdropClickHandler);
    }

    function showSpinnerOnButton(btn, show, originalText) {
      if (!btn) return;
      if (show) {
        btn.dataset.orig = btn.innerHTML;
        btn.classList.add('primary','loading');
        btn.innerHTML = '<div class="spinner"></div> Submitting...';
        btn.disabled = true; // Disable the button to prevent double-clicks
      } else {
        btn.classList.remove('loading');
        btn.innerHTML = originalText || btn.dataset.orig || 'Submit';
        btn.disabled = false;
      }
    }

    /********************** auth & profile lookup **********************/
    // Try to find user profile by many possible shapes:
    // 1) users_by_uid/{uid} (preferred)
    // 2) users/{studentId} (where each user object contains uid/email/studentId)
    async function findProfileForUid(uid) {
      if (!uid) return null;
      try {
        // 1) try dedicated mapping
        const byUidSnap = await get(ref(db, `users_by_uid/${uid}`));
        if (byUidSnap.exists()) {
          return byUidSnap.val();
        }
        // 2) fallback: scan users/ to find matching uid
        const usersSnap = await get(ref(db, `users`));
        if (usersSnap.exists()) {
          const allUsers = usersSnap.val();
          for (const key of Object.keys(allUsers)) {
            const u = allUsers[key];
            if (u && (u.uid === uid || u.uid === uid.toString())) {
              // prefer to return normalized object
              return {
                studentId: u.studentId || u.student_id || key,
                email: u.email || u.email_address || '',
                full_name: u.full_name || u.name || '',
                department: u.department || ''
              };
            }
          }
        }
      } catch (err) {
        console.error('findProfileForUid error', err);
      }
      return null;
    }

    /********************** CARD: Edit Profile (modal form) **********************/
    profileCardLink.addEventListener('click', () => {
      const modalHtml = `
        <header>
          <h2>Edit Your Profile</h2>
          <button id="closeModalBtn" class="close-btn">Close</button>
        </header>
        <div class="form">
          <label>Full Name</label>
          <input type="text" id="p-fullname" value="${profile?.full_name || ''}" />

          <label>Student ID</label>
          <input type="text" id="p-studentId" readonly value="${profile?.studentId || ''}" />

          <label>Faculty</label>
          <select id="p-faculty">
            <option value="">-- Select a Faculty --</option>
            ${Object.keys(facultyProgrammes).map(faculty => `<option value="${faculty}" ${profile?.faculty === faculty ? 'selected' : ''}>${faculty}</option>`).join('')}
          </select>

          <label>Programme</label>
          <select id="p-programme">
            <option value="">-- Select a Programme --</option>
          </select>

          <label>Group</label>
          <select id="p-department">
            <option value="Group A" ${profile?.department === 'Group A' ? 'selected' : ''}>Group A</option>
            <option value="Group B" ${profile?.department === 'Group B' ? 'selected' : ''}>Group B</option>
            <option value="Group C" ${profile?.department === 'Group C' ? 'selected' : ''}>Group C</option>
            <option value="Group D" ${profile?.department === 'Group D' ? 'selected' : ''}>Group D</option>
            <option value="Group E" ${profile?.department === 'Group E' ? 'selected' : ''}>Group E</option>
            <option value="Group F" ${profile?.department === 'Group F' ? 'selected' : ''}>Group F</option>
            <option value="Group G" ${profile?.department === 'Group G' ? 'selected' : ''}>Group G</option>
            <option value="Group H" ${profile?.department === 'Group H' ? 'selected' : ''}>Group H</option>
            <option value="Group I" ${profile?.department === 'Group I' ? 'selected' : ''}>Group I</option>
            <option value="Group J" ${profile?.department === 'Group J' ? 'selected' : ''}>Group J</option>
            <option value="Group K" ${profile?.department === 'Group K' ? 'selected' : ''}>Group K</option>
            <option value="Group L" ${profile?.department === 'Group L' ? 'selected' : ''}>Group L</option>
            <option value="Group M" ${profile?.department === 'Group M' ? 'selected' : ''}>Group M</option>
            <option value="Group N" ${profile?.department === 'Group N' ? 'selected' : ''}>Group N</option>
            <option value="Group O" ${profile?.department === 'Group O' ? 'selected' : ''}>Group O</option>
            <option value="Group P" ${profile?.department === 'Group P' ? 'selected' : ''}>Group P</option>
          </select>

          <label>Level</label>
          <select id="p-level">
            <option value="Level 100" ${profile?.level === 'Level 100' ? 'selected' : ''}>Level 100</option>
            <option value="Level 200" ${profile?.level === 'Level 200' ? 'selected' : ''}>Level 200</option>
            <option value="Level 300" ${profile?.level === 'Level 300' ? 'selected' : ''}>Level 300</option>
            <option value="Level 400" ${profile?.level === 'Level 400' ? 'selected' : ''}>Level 400</option>
          </select>

          <label>Current Semester</label>
          <select id="p-semester">
            <option value="First Semester" ${profile?.semester === 'First Semester' ? 'selected' : ''}>First Semester</option>
            <option value="Second Semester" ${profile?.semester === 'Second Semester' ? 'selected' : ''}>Second Semester</option>
          </select>

          <label>Session</label>
          <select id="p-session">
            <option value="Morning" ${profile?.session === 'Morning' ? 'selected' : ''}>Morning</option>
            <option value="Evening" ${profile?.session === 'Evening' ? 'selected' : ''}>Evening</option>
            <option value="Weekend" ${profile?.session === 'Weekend' ? 'selected' : ''}>Weekend</option>
          </select>

          <button id="p-submit" class="primary">Save Changes</button>
        </div>
      `;
      openModal(modalHtml);
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);

      const facultySelect = document.getElementById('p-faculty');
      const programmeSelect = document.getElementById('p-programme');

      const updateProgrammeOptions = (selectedFaculty) => {
        programmeSelect.innerHTML = '<option value="">-- Select a Programme --</option>'; // Reset
        if (selectedFaculty && facultyProgrammes[selectedFaculty]) {
          facultyProgrammes[selectedFaculty].forEach(programme => {
            const option = document.createElement('option');
            option.value = programme;
            option.textContent = programme;
            if (profile?.programme === programme) {
              option.selected = true;
            }
            programmeSelect.appendChild(option);
          });
        }
      };

      // Initial population
      if (facultySelect.value) {
        updateProgrammeOptions(facultySelect.value);
      }

      // Event listener for changes
      facultySelect.addEventListener('change', (e) => {
        profile.programme = ''; // Reset programme when faculty changes
        updateProgrammeOptions(e.target.value);
      });

      document.getElementById('p-submit').addEventListener('click', async (e) => {
        e.preventDefault();
        const btn = e.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Saving...';

        const updatedProfile = {
          full_name: document.getElementById('p-fullname').value,
          studentId: document.getElementById('p-studentId').value,
          faculty: document.getElementById('p-faculty').value,
          programme: document.getElementById('p-programme').value,
          department: document.getElementById('p-department').value,
          level: document.getElementById('p-level').value,
          semester: document.getElementById('p-semester').value,
          session: document.getElementById('p-session').value,
        };

        try {
          const user = auth.currentUser;
          if (user) {
            // Update both users_by_uid and users paths for consistency
            const userByUidRef = ref(db, `users_by_uid/${user.uid}`);
            const userByStudentIdRef = ref(db, `users/${updatedProfile.studentId}`);
            
            // Enhanced profile data with all fields
            const enhancedProfile = {
              ...updatedProfile,
              uid: user.uid,
              email: user.email,
              studentID: updatedProfile.studentId, // Add both formats
              student_id: updatedProfile.studentId,
              group: updatedProfile.department, // Map department to group for consistency
              updatedAt: new Date().toISOString()
            };
            
            await update(userByUidRef, enhancedProfile);
            await update(userByStudentIdRef, enhancedProfile);

            // Also update the local profile object immediately
            profile = { ...profile, ...enhancedProfile };
            renderProfileData(); // Re-render the UI with new data

            showToast('Profile updated successfully!', 'success');
            setTimeout(closeModal, 700);
          } else {
            showToast('User not authenticated.', 'error');
          }
        } catch (err) {
          console.error('Profile update error:', err);
          showToast('Error updating profile: ' + err.message, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'Save Changes';
        }
      });
    });

    function renderProfileData() {
      if (profile && profile.full_name && profile.studentId) {
        studentNameDisplay.textContent = `Hello, ${profile.full_name}`;
        studentIdDisplay.textContent = profile.studentId;
        document.getElementById('s-studentId').textContent = profile.studentId;
        document.getElementById('s-faculty').textContent = profile.faculty || 'â€”';
        document.getElementById('s-department').textContent = profile.department || 'â€”';
        document.getElementById('s-programme').textContent = profile.programme || 'â€”';
        document.getElementById('s-level').textContent = profile.level || 'â€”';
        document.getElementById('s-semester').textContent = profile.semester || 'â€”';
        document.getElementById('s-session').textContent = profile.session || 'â€”';
      } else if (auth.currentUser && auth.currentUser.email) {
        // fallback: show email as ID, but not "Student"
        studentNameDisplay.textContent = `Hello, ${auth.currentUser.displayName || auth.currentUser.email.split('@')[0] || 'Student'}`;
        studentIdDisplay.textContent = auth.currentUser.email;
        document.getElementById('s-studentId').textContent = auth.currentUser.email;
        document.getElementById('s-faculty').textContent = 'â€”';
        document.getElementById('s-department').textContent = 'â€”';
        document.getElementById('s-programme').textContent = 'â€”';
        document.getElementById('s-level').textContent = 'â€”';
        document.getElementById('s-semester').textContent = 'â€”';
        document.getElementById('s-session').textContent = 'â€”';
      } else {
        studentNameDisplay.textContent = `Hello, Student`;
        studentIdDisplay.textContent = 'No ID';
        document.getElementById('s-studentId').textContent = 'No ID';
        document.getElementById('s-faculty').textContent = 'â€”';
        document.getElementById('s-department').textContent = 'â€”';
        document.getElementById('s-programme').textContent = 'â€”';
        document.getElementById('s-level').textContent = 'â€”';
        document.getElementById('s-semester').textContent = 'â€”';
        document.getElementById('s-session').textContent = 'â€”';
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUID = user.uid;
        // find profile
        profile = await findProfileForUid(currentUID);
        renderProfileData();
        updateNotificationCount();
      } else {
        window.location.href = 'login.html';
      }
    });

    // Logout button
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('Signed out', 'info');
        setTimeout(()=> window.location.href = 'login.html', 700);
      } catch (err) {
        showToast('Sign out failed: ' + err.message, 'error');
      }
    });

    /********************** Notification count helper **********************/
    function updateNotificationCount() {
      if (!currentUID) {
        notificationCount.style.display = 'none';
        notificationBell.classList.remove('bell-active');
        return;
      }
      // Attach a live listener to notifications
      if (notificationsListenerRef) {
        try { off(notificationsListenerRef); } catch(e){/*noop*/ }
      }
      notificationsListenerRef = ref(db, `notifications/${currentUID}`);
      onValue(notificationsListenerRef, (snap) => {
        let count = 0;
        if (snap.exists()) {
          const entries = snap.val();
          count = Object.values(entries).filter(x => !x.is_read || x.is_read === false).length;

        }
        if (count > 0) {
          notificationCount.textContent = count;
          notificationCount.style.display = 'flex';
          notificationBell.classList.add('bell-active');
        } else {
          notificationCount.style.display = 'none';
          notificationBell.classList.remove('bell-active');
        }
      }, (err) => {
        console.error('Error fetching notifications:', err);
      });
    }

    /********************** Data Loading & Rendering **********************/
    // Logout button
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('Signed out', 'info');
        setTimeout(()=> window.location.href = 'login.html', 700);
      } catch (err) {
        showToast('Sign out failed: ' + err.message, 'error');
      }
    });

    /********************** CLICK HANDLERS FOR NEW FEATURES **********************/

    // Make Notifications button clickable and functional
    notificationBell.addEventListener('click', async () => {
      if (!currentUID) {
        showToast('Please log in to view notifications.', 'info');
        return;
      }
      const modalHtml = `
        <header>
          <h2>Notifications</h2>
          <button id="closeNotificationsModal" class="close-btn">Close</button>
        </header>
        <div style="max-height:60vh; overflow:auto; padding-top:8px;">
          <ul id="notificationsList"></ul>
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button id="markAllReadBtn" class="primary">Mark All As Read</button>
        </div>
      `;
      openModal(modalHtml);
      document.getElementById('closeNotificationsModal').addEventListener('click', closeModal);
      document.getElementById('markAllReadBtn').addEventListener('click', markAllNotificationsAsRead);

      attachNotificationsListener();
    });

    function attachNotificationsListener() {
      const listEl = document.getElementById('notificationsList');
      if (!currentUID) {
        listEl.innerHTML = '<li>Please sign in to view notifications.</li>';
        return;
      }

      const notificationsRef = ref(db, `notifications/${currentUID}`);
      if (notificationsListenerRef) {
        try { off(notificationsListenerRef); } catch(e){/*noop*/ }
      }
      notificationsListenerRef = notificationsRef;

      onValue(notificationsRef, (snap) => {
        listEl.innerHTML = '';
        if (!snap.exists()) {
          listEl.innerHTML = '<li class="item">No new notifications.</li>';
          return;
        }
        const val = snap.val();
        const arr = Object.entries(val).map(([id, obj]) => ({ id, ...obj }));
        arr.sort((a,b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
        arr.forEach(item => {
          const li = document.createElement('li');
          li.className = 'item';
          if (!item.is_read) {
            li.style.background = '#eef2ff';
            li.style.fontWeight = '600';
          }
          li.innerHTML = `
            <div class="item-left">
              ${escapeHtml(item.message || '')}
              <div class="meta">${new Date(item.created_at || Date.now()).toLocaleString()}</div>
            </div>
          `;
          listEl.appendChild(li);
        });
        // Mark all as read after opening modal
        markAllNotificationsAsRead();
      }, (err) => {
        listEl.innerHTML = '<li class="item">Failed to load notifications.</li>';
        showToast('Error fetching notifications: ' + err.message, 'error');
      });
    }

    async function markAllNotificationsAsRead() {
      if (!currentUID) return;
      try {
        const notificationsRef = ref(db, `notifications/${currentUID}`);
        const snap = await get(notificationsRef);
        if (snap.exists()) {
          const updates = {};
          const entries = snap.val();
          Object.keys(entries).forEach(key => {
            updates[key + '/is_read'] = true;
          });
          await update(notificationsRef, updates);
        }
      } catch (err) {
        console.error('Failed to mark notifications as read:', err);
      }
    }

    /********************** CARD: Report Results Issue (modal form) **********************/
    document.getElementById('resultsCard').addEventListener('click', (e) => {
      const groupOptions = Array.from({length: 16}, (_, i) => String.fromCharCode(65 + i)).map(g => `<option value="Group ${g}">Group ${g}</option>`).join('');
      const modalHtml = `
        <header>
          <h2>Report Results Issue</h2>
          <button id="closeModalBtn" class="close-btn">Close</button>
        </header>
        <div class="form">
          <label>Student ID</label>
          <input type="text" id="ri-studentId" readonly value="${profile?.studentId || ''}" />

          <label>Faculty</label>
          <input type="text" id="ri-faculty" readonly value="${profile?.faculty || ''}" />

          <label>Group</label>
          <input type="text" id="ri-department" readonly value="${profile?.department || ''}" />

          <label>Programme</label>
          <input type="text" id="ri-programme" readonly value="${profile?.programme || ''}" />

          <label>Session</label>
          <input type="text" id="ri-session" readonly value="${profile?.session || ''}" />

          <label>Group</label>
          <select id="ri-group">
            <option value="">Select Group</option>
            ${groupOptions}
          </select>

          <label>Course Code</label>
          <input type="text" id="ri-course" placeholder="e.g., CBT 101" />

          <label>Course Title</label>
          <input type="text" id="ri-course-title" placeholder="e.g., Introduction to Computing" />

          <label>Name of Lecturer</label>
          <input type="text" id="ri-lecturer" placeholder="e.g., Dr. Gideon Genius" />

          <label>Issue Description</label>
          <select id="ri-desc">
            <option value="">Select an issue</option>
            <option>Missing Grade</option>
            <option>Discrepancy in Grade</option>
            <option>Incorrect Course Registration</option>
            <option>Not on Examination List</option>
          </select>

          <label>Any Comment? <span style="color:#888;font-weight:normal;">(optional)</span></label>
          <textarea id="ri-comment" placeholder="Add any additional details..."></textarea>

          <button id="ri-submit" class="primary">Submit Results Issue</button>
        </div>
      `;
      openModal(modalHtml);

      // set student id value (in case profile loaded after click)
      const rid = document.getElementById('ri-studentId');
      if (profile && profile.studentId) rid.value = profile.studentId;
      // close handler
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);

      // submit handler
      document.getElementById('ri-submit').addEventListener('click', async (ev) => {
        ev.preventDefault();
        const btn = ev.currentTarget;
        const orig = btn.innerHTML;
        showSpinnerOnButton(btn, true);

        const payload = {
          student_id: profile?.studentId || '',
          faculty: profile?.faculty || '',
          department: profile?.department || '',
          programme: profile?.programme || '',
          session: profile?.session || '',
          group: document.getElementById('ri-group').value,
          course_code: document.getElementById('ri-course').value.trim(),
          course_title: document.getElementById('ri-course-title').value.trim(),
          lecturer_name: document.getElementById('ri-lecturer').value.trim(),
          description: document.getElementById('ri-desc').value,
          comment: document.getElementById('ri-comment').value.trim(),
          date_submitted: new Date().toISOString(),
          status: 'Queued'
        };

        // validations
        if (!payload.faculty || !payload.course_code || !payload.description) {
          showToast('Please fill faculty, course code and issue description.', 'error');
          showSpinnerOnButton(btn, false, orig);
          return;
        }

        try {
          // store under results_issues/{uid}/{pushId}
const newRFlat = push(ref(db, `result_issues`)); // <-- push first to get the key
const resultsRefStudent = ref(db, `results_issues/${payload.student_id}/${newRFlat.key}`); // <-- now use the key
const resultData = {
  id: newRFlat.key,
  student_id: payload.student_id,
  faculty: payload.faculty,
  course_code: payload.course_code,
  lecturer_name: payload.lecturer_name,
  description: payload.description,
  date_submitted: payload.date_submitted,
  status: 'Queued'
};
await set(newRFlat, resultData);
await set(resultsRefStudent, resultData);


          // add a notification
          await push(ref(db, `notifications/${currentUID}`), {
            message: 'Results issue submitted',
            created_at: new Date().toISOString(),
            is_read: false
          });

          showToast('Results issue submitted.', 'success');

          // refresh any open views (if track modal open)
          refreshResultsListIfOpen();

          setTimeout(() => {
            closeModal();
          }, 700);
        } catch (err) {
          showToast('Error submitting results issue: ' + err.message, 'error');
        } finally {
          showSpinnerOnButton(btn, false, orig);
          updateNotificationCount();
        }
      });
    });

    /********************** CARD: Make a Complaint (modal form) **********************/
    document.getElementById('complaintCard').addEventListener('click', (e) => {
      const modalHtml = `
        <header>
          <h2>Submit a Complaint</h2>
          <button id="closeModalBtn" class="close-btn">Close</button>
        </header>
        <div class="form">
          <label>Student ID</label>
          <input type="text" id="c-studentId" readonly value="${profile?.studentId || ''}" />

          <label>Complaint Subject</label>
          <input type="text" id="c-subject" placeholder="e.g., Timetable Clash" />

          <label>Complaint Type</label>
          <select id="c-type">
            <option value="" disabled selected>Select a type</option>
            <option value="Academic">Academic</option>
            <option value="Administrative">Administrative</option>
            <option value="Facilities">Facilities</option>
            <option value="Other">Other</option>
          </select>

          <label>Submit To</label>
          <select id="c-recipient">
            <option value="General" selected>General (visible to all relevant admins)</option>
            <option value="HOD" data-email="hod@gctu.edu.gh">Head of Department (HOD)</option>
            <option value="Registrar" data-email="registrar@gctu.edu.gh">Registrar</option>
            <option value="Dean" data-email="dean@gctu.edu.gh">Dean</option>
            <option value="Exam" data-email="exam@gctu.edu.gh">Exam Officer</option>
          </select>

          <label>Complaint Message</label>
          <textarea id="c-message" placeholder="Please describe your complaint in detail..."></textarea>

          <button id="c-submit" class="primary">Submit Complaint</button>
        </div>
      `;
      openModal(modalHtml);
      const closeBtn = document.getElementById('closeModalBtn');
      closeBtn.addEventListener('click', closeModal);

      const submitBtn = document.getElementById('c-submit');
      submitBtn.addEventListener('click', async (ev) => {
        ev.preventDefault();
        const orig = submitBtn.innerHTML;
        showSpinnerOnButton(submitBtn, true);

        const studentIdValue = document.getElementById('c-studentId').value || (profile && profile.studentId) || '';
        const subjectValue = document.getElementById('c-subject').value.trim();
        const typeValue = document.getElementById('c-type').value;
        const recipientValue = document.getElementById('c-recipient').value;
        const messageValue = document.getElementById('c-message').value.trim();

        if (!subjectValue || !typeValue || !recipientValue || !messageValue) {
          showToast('Please fill all fields.', 'error');
          showSpinnerOnButton(submitBtn, false, orig);
          return;
        }

        try {
          // Get the selected recipient option to extract email
          const recipientSelect = document.getElementById('c-recipient');
          const selectedOption = recipientSelect.options[recipientSelect.selectedIndex];
          const recipientEmail = selectedOption.getAttribute('data-email') || null;
          
          const complaintData = {
            student_id: studentIdValue,
            user_uid: currentUID,
            subject: subjectValue,
            type: typeValue,
            recipient: recipientValue,
            recipient_email: recipientEmail,
            text: messageValue,
            status: 'Queued',
            date_submitted: new Date().toISOString(),
            // Attach full academic info from profile
            department: profile?.department || 'N/A',
            programme: profile?.programme || 'N/A',
            level: profile?.level || 'N/A',
            session: profile?.session || 'N/A',
            faculty: profile?.faculty || 'N/A',
            // Add routing information for admin panels
            admin_route: recipientValue !== 'General' ? recipientValue.toLowerCase() : 'general'
          };

          // store under complaints/{pushId}
          const newComplaintFlat = push(ref(db, `complaints`));
          const newComplaintStudent = ref(db, `complaints/${studentIdValue}/${newComplaintFlat.key}`);
          const complaintDataWithId = {
            ...complaintData,
            id: newComplaintFlat.key
          };
          await set(newComplaintFlat, complaintDataWithId);
          await set(newComplaintStudent, complaintDataWithId);


          // add a notification
          await push(ref(db, `notifications/${currentUID}`), {
            message: 'Complaint submitted',
            created_at: new Date().toISOString(),
            is_read: false
          });

          showToast('Complaint submitted successfully.', 'success');

          setTimeout(() => {
            closeModal();
          }, 700);

        } catch (err) {
          showToast('Error submitting complaint: ' + err.message, 'error');
        } finally {
          showSpinnerOnButton(submitBtn, false, orig);
          updateNotificationCount();
        }
      });
    });

    /********************** CARD: Track Complaints **********************/
    document.getElementById('trackComplaintsCard').addEventListener('click', () => {
      if (!profile || !profile.studentId) {
        showToast('Profile not loaded yet.', 'error');
        return;
      }

      const modalHtml = `
        <header>
          <h2>Track Complaints</h2>
          <button id="closeTrackComplaintsModal" class="close-btn">Close</button>
        </header>
        <div style="max-height:60vh; overflow:auto; padding-top:8px;">
          <ul id="complaintsList"></ul>
        </div>
      `;
      openModal(modalHtml);
      document.getElementById('closeTrackComplaintsModal').addEventListener('click', closeModal);

      const listEl = document.getElementById('complaintsList');
      const complaintsRef = ref(db, `complaints/${profile.studentId}`);

      if (complaintsListenerRef) off(complaintsListenerRef);
      complaintsListenerRef = complaintsRef;

      onValue(complaintsRef, (snap) => {
        listEl.innerHTML = '';
        if (!snap.exists()) {
          listEl.innerHTML = '<li class="item">No complaints submitted yet.</li>';
          return;
        }
        const arr = Object.entries(snap.val()).map(([id, obj]) => ({ id, ...obj }));
        arr.sort((a,b) => new Date(b.date_submitted) - new Date(a.date_submitted));
        arr.forEach(c => {
          const li = document.createElement('li');
          li.className = 'item';
          li.innerHTML = `
            <div class="item-left">
              ${escapeHtml(c.text)}
              <div class="meta">${new Date(c.date_submitted).toLocaleString()}</div>
            </div>
            <div class="status-pill s-${c.status.replace(/\s/g,'')}" onclick="showProgressModal('complaint', '${c.id}', '${c.status}', '${escapeHtml(c.subject || c.text)}')" title="Click to view progress details">${c.status}</div>
            <button class="delete-btn" data-id="${c.id}" style="margin-left:12px;background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">Delete</button>
          `;
          li.querySelector('.delete-btn').addEventListener('click', async () => {
            try {
              // Remove from flat path
              await update(ref(db), { [`complaints/${c.id}`]: null });
              // Remove from per-student path
              await update(ref(db), { [`complaints/${profile.studentId}/${c.id}`]: null });
              showToast('Complaint deleted.', 'success');
              li.remove();
            } catch (err) {
              showToast('Failed to delete complaint: ' + err.message, 'error');
            }
          });
          listEl.appendChild(li);
        });
      });
    });

    /********************** CARD: Track Results Issues **********************/
    document.getElementById('trackResultsCard').addEventListener('click', () => {
      if (!profile || !profile.studentId) {
        showToast('Profile not loaded yet.', 'error');
        return;
      }

      const modalHtml = `
        <header>
          <h2>Track Results Issues</h2>
          <button id="closeTrackResultsModal" class="close-btn">Close</button>
        </header>
        <div style="max-height:60vh; overflow:auto; padding-top:8px;">
          <ul id="resultsList"></ul>
        </div>
      `;
      openModal(modalHtml);
      document.getElementById('closeTrackResultsModal').addEventListener('click', closeModal);

      refreshResultsListIfOpen();
    });

    function refreshResultsListIfOpen() {
      if (!profile) return;
      const listEl = document.getElementById('resultsList');
      if (!listEl) return;
      const resultsRef = ref(db, `results_issues/${profile.studentId}`);

      if (resultsListenerRef) off(resultsListenerRef);
      resultsListenerRef = resultsRef;

      onValue(resultsRef, (snap) => {
        listEl.innerHTML = '';
        if (!snap.exists()) {
          listEl.innerHTML = '<li class="item">No results issues submitted yet.</li>';
          return;
        }
        const arr = Object.entries(snap.val()).map(([id,obj]) => ({ id, ...obj }));
        arr.sort((a,b) => new Date(b.date_submitted) - new Date(a.date_submitted));
        arr.forEach(r => {
          const li = document.createElement('li');
          li.className = 'item';
          li.innerHTML = `
            <div class="item-left">
              <strong>${escapeHtml(r.course_code || 'Course')}</strong> - ${escapeHtml(r.description)}
              <div class="meta">${new Date(r.date_submitted).toLocaleString()}</div>
            </div>
            <div class="status-pill s-${r.status.replace(/\s/g,'')}" onclick="showProgressModal('result', '${r.id}', '${r.status}', '${escapeHtml(r.course_code || 'Result Issue')}')" title="Click to view progress details">${r.status}</div>
            <button class="delete-btn" data-id="${r.id}" style="margin-left:12px;background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">Delete</button>
          `;
            li.querySelector('.delete-btn').addEventListener('click', async () => {
            try {
              // Mark as inactive instead of deleting completely
              const timestamp = new Date().toISOString();
              const updates = {
                status: 'inactive',
                inactive_date: timestamp,
                updated_at: timestamp
              };
              
              // Update flat path
              await update(ref(db, `result_issues/${r.id}`), updates);
              // Update per-student path
              await update(ref(db, `results_issues/${profile.studentId}/${r.id}`), updates);
              
              showToast('Result issue moved to inactive.', 'success');
              li.remove();
            } catch (err) {
              showToast('Failed to update result issue: ' + err.message, 'error');
            }
          });
          listEl.appendChild(li);
        });
      });
    }

    // simple helper to avoid XSS
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }

    /********************** Progress Modal Functionality **********************/
    function showProgressModal(type, itemId, currentStatus, title) {
      // Mock progress data - in real implementation, this would come from Firebase
      const progressData = generateMockProgressData(type, currentStatus);
      
      const modalHtml = `
        <header>
          <h2>Progress Details</h2>
          <button id="closeProgressModal" class="close-btn">Close</button>
        </header>
        <div style="padding: 8px 0;">
          <div style="margin-bottom: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 1.1rem;">${escapeHtml(title)}</h3>
            <div class="status-pill s-${currentStatus.replace(/\s/g,'')}" style="cursor: default;">${currentStatus}</div>
          </div>
          
          <div class="progress-timeline">
            ${progressData.map(item => `
              <div class="timeline-item ${item.status}">
                <div class="timeline-dot ${item.status}"></div>
                <div class="timeline-content">
                  <h4>${item.title}</h4>
                  <p>${item.description}</p>
                  ${item.timestamp ? `<div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>` : ''}
                  ${item.adminNote ? `<div style="margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 4px; font-size: 0.8rem;"><strong>Admin Note:</strong> ${item.adminNote}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
          
          <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
            <p style="margin: 0; font-size: 0.9rem; color: #0c4a6e;">
              <strong>What's Next:</strong> ${getNextStepMessage(currentStatus, type)}
            </p>
          </div>
        </div>
      `;
      
      openModal(modalHtml);
      document.getElementById('closeProgressModal').addEventListener('click', closeModal);
    }

    function generateMockProgressData(type, currentStatus) {
      const baseTimestamp = Date.now();
      const dayMs = 24 * 60 * 60 * 1000;
      
      if (type === 'complaint') {
        const steps = [
          {
            title: 'Complaint Submitted',
            description: 'Your complaint has been successfully submitted and assigned a reference number.',
            status: 'completed',
            timestamp: baseTimestamp - (3 * dayMs),
            adminNote: 'Complaint received and logged in the system.'
          },
          {
            title: 'Initial Review',
            description: 'Admin team is reviewing your complaint and determining the appropriate department.',
            status: currentStatus === 'Queued' ? 'current' : 'completed',
            timestamp: currentStatus !== 'Queued' ? baseTimestamp - (2 * dayMs) : null,
            adminNote: currentStatus !== 'Queued' ? 'Complaint categorized and assigned to relevant department.' : null
          },
          {
            title: 'Investigation in Progress',
            description: 'The relevant department is actively investigating your complaint.',
            status: currentStatus === 'In Progress' ? 'current' : (currentStatus === 'Resolved' || currentStatus === 'inactive' ? 'completed' : 'pending'),
            timestamp: currentStatus === 'In Progress' || currentStatus === 'Resolved' || currentStatus === 'inactive' ? baseTimestamp - dayMs : null,
            adminNote: currentStatus === 'In Progress' ? 'Investigation team assigned and working on resolution.' : null
          },
          {
            title: currentStatus === 'inactive' ? 'Complaint Deleted' : 'Resolution Complete',
            description: currentStatus === 'inactive' ? 'Your complaint has been moved to inactive status by an administrator.' : 'Your complaint has been resolved and appropriate actions have been taken.',
            status: (currentStatus === 'Resolved' || currentStatus === 'inactive') ? 'completed' : 'pending',
            timestamp: (currentStatus === 'Resolved' || currentStatus === 'inactive') ? baseTimestamp : null,
            adminNote: currentStatus === 'Resolved' ? 'Issue resolved. Follow-up communication sent to student.' : 
                      currentStatus === 'inactive' ? 'Complaint moved to inactive status by admin. Items are automatically deleted after 30 days.' : null
          }
        ];
        return steps;
      } else {
        const steps = [
          {
            title: 'Results Issue Reported',
            description: 'Your results issue has been submitted and is awaiting review.',
            status: 'completed',
            timestamp: baseTimestamp - (3 * dayMs),
            adminNote: 'Results issue logged and assigned to academic records team.'
          },
          {
            title: 'Academic Review',
            description: 'Academic office is verifying your results and checking for discrepancies.',
            status: currentStatus === 'Queued' ? 'current' : 'completed',
            timestamp: currentStatus !== 'Queued' ? baseTimestamp - (2 * dayMs) : null,
            adminNote: currentStatus !== 'Queued' ? 'Records verified with course lecturer and examination office.' : null
          },
          {
            title: 'Correction in Progress',
            description: 'Necessary corrections are being made to your academic records.',
            status: currentStatus === 'In Progress' ? 'current' : (currentStatus === 'Resolved' || currentStatus === 'inactive' ? 'completed' : 'pending'),
            timestamp: currentStatus === 'In Progress' || currentStatus === 'Resolved' || currentStatus === 'inactive' ? baseTimestamp - dayMs : null,
            adminNote: currentStatus === 'In Progress' ? 'Corrections approved and being processed in the system.' : null
          },
          {
            title: currentStatus === 'inactive' ? 'Issue Deleted' : 'Results Updated',
            description: currentStatus === 'inactive' ? 'Your results issue has been moved to inactive status by an administrator.' : 'Your academic records have been updated and the issue is resolved.',
            status: (currentStatus === 'Resolved' || currentStatus === 'inactive') ? 'completed' : 'pending',
            timestamp: (currentStatus === 'Resolved' || currentStatus === 'inactive') ? baseTimestamp : null,
            adminNote: currentStatus === 'Resolved' ? 'Updated results published. Student portal reflects changes.' : 
                      currentStatus === 'inactive' ? 'Results issue moved to inactive status by admin. Items are automatically deleted after 30 days.' : null
          }
        ];
        return steps;
      }
    }

    function getNextStepMessage(status, type) {
      if (type === 'complaint') {
        switch (status) {
          case 'Queued':
            return 'Your complaint is in the review queue. An admin will begin the initial review within 24-48 hours.';
          case 'In Progress':
            return 'Investigation is underway. You may be contacted for additional information if needed.';
          case 'Resolved':
            return 'Your complaint has been resolved. If you have any follow-up questions, please submit a new complaint.';
          case 'inactive':
            return 'Your complaint has been moved to inactive status. It will be automatically deleted after 30 days. If you believe this was done in error, please contact the administration.';
          default:
            return 'Please check back later for updates on your complaint status.';
        }
      } else {
        switch (status) {
          case 'Queued':
            return 'Your results issue is being reviewed by the academic office. This typically takes 2-3 business days.';
          case 'In Progress':
            return 'Corrections are being processed. Updated results should be available within 1-2 business days.';
          case 'Resolved':
            return 'Your results have been updated. Please check your student portal to view the corrected information.';
          case 'inactive':
            return 'Your results issue has been moved to inactive status. It will be automatically deleted after 30 days. If you believe this was done in error, please contact the administration.';
          default:
            return 'Please check back later for updates on your results issue.';
        }
      }
    }

    // Automatically log out student when they leave the tab or window
    window.addEventListener('beforeunload', () => {
      // This will sign out the user when they close or reload the tab/window
      signOut(auth);
    });

    // --- Inactivity auto-logout (15 minutes of inactivity) ---
let inactivityTimeout;
const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 minutes instead of 1 minute

function resetInactivityTimer() {
  if (inactivityTimeout) clearTimeout(inactivityTimeout);
  inactivityTimeout = setTimeout(() => {
    // Only logout if user is still authenticated and not in a modal
    if (auth.currentUser && !modalBackdrop.style.display || modalBackdrop.style.display === 'none') {
      signOut(auth).then(() => {
        showToast('Logged out due to inactivity.', 'info');
        setTimeout(() => window.location.href = 'login.html', 700);
      }).catch(err => {
        console.error('Logout error:', err);
      });
    }
  }, INACTIVITY_LIMIT);
}

// Listen for user activity (but not during form submissions)
['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll'].forEach(evt =>
  window.addEventListener(evt, (e) => {
    // Don't reset timer during form submissions to prevent logout
    if (e.target && (e.target.type === 'submit' || (e.target.classList && e.target.classList.contains('primary')))) {
      return;
    }
    resetInactivityTimer();
  })
);

// Start the timer on page load
resetInactivityTimer();

// Make functions globally accessible for onclick handlers
window.showProgressModal = showProgressModal;
window.escapeHtml = escapeHtml;
  </script>
</body>
</html>