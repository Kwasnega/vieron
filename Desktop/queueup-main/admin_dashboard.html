<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/x-icon" href="gctu.ico" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - QUEUEUP</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  :root {
    --primary-color: #007bff;
    --info-color: #17a2b8;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --bg: #f8f9fa;
    --card: #ffffff;
    --muted: #6c757d;
    --border: #e9ecef;
    --shadow: rgba(0,0,0,0.05);
  }
  body.dark-mode {
    --primary-color: #90caf9;
    --info-color: #4dd0e1;
    --success-color: #66bb6a;
    --danger-color: #ef5350;
    --bg: #181a1b;
    --card: #23272b;
    --muted: #b0b3b8;
    --border: #33383d;
    --shadow: rgba(0,0,0,0.4);
    color: #e0e0e0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.2s, color 0.2s, box-shadow 0.2s, border 0.2s; }

  body {
    font-family: "Poppins", sans-serif;
  padding: 0;
    background: var(--bg);
    color: #222;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    width: 100%;
    max-width: 1200px;
    margin: 18px auto;
    padding: 18px;
    border-radius: 18px;
    background: #fff;
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
  }

  /* Navbar */
  .navbar {
  position: sticky;
  top: 0;
  z-index: 1000;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card);
  padding: 12px 18px;
  border-radius: 16px;
  box-shadow: 0 8px 32px var(--shadow);
  margin-bottom: 12px;
  gap: 12px;
  }

  .navbar-brand {
    display: flex;
    align-items: center;
    margin-right: auto;
  }

  .logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
  }

  .brand-text {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary-color);
  }

  #logout-btn {
    background: var(--primary-color);
    color: #fff;
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s ease;
    margin-left: auto;
  }
  #logout-btn:hover { background: #0056b3; }

  /* Tabs */
  .nav-tabs {
    display: flex;
    gap: 8px;
    margin: 16px 0;
    flex-wrap: wrap;
  }
  .nav-tab {
    padding: 10px 18px;
    border-radius: 10px 10px 0 0;
    cursor: pointer;
    background: transparent;
    border-bottom: 3px solid transparent;
    color: var(--muted);
    font-weight: 500;
    outline: none;
  }
  .nav-tab:focus {
    box-shadow: 0 0 0 2px var(--primary-color);
  }
  .nav-tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: rgba(0,0,0,0.04);
    font-weight: 700;
  }

  /* Dashboard grid */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 18px;
  }

  .card {
    background: var(--card);
    border-radius: 16px;
    padding: 22px 18px 18px 18px;
    box-shadow: 0 8px 32px var(--shadow);
    margin-bottom: 12px;
  }

  .metric-card .value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-color);
  }

  .chart-container { height: 340px; }

  /* Lists */
  .list-container { padding: 12px; }
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .list-header input,
  .list-header select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  table.list-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  table.list-table th,
  table.list-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }

  /* Buttons */
  .action-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .action-btn:focus {
    box-shadow: 0 0 0 2px var(--primary-color);
  }
  .done-btn { background: var(--success-color); color: #fff; }
  .done-btn:hover { background: #218838; }
  .in-progress-btn { background: var(--primary-color); color: #fff; }
  .in-progress-btn:hover { background: #0056b3; }
  .escalate-btn { background: var(--danger-color); color: #fff; }
  .escalate-btn:hover { background: #b71c1c; }
  .view-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .view-btn:hover { background: var(--bg); color: var(--primary-color); border-color: var(--primary-color); }

  /* Modal */
  .modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal {
    width: 100%;
    max-width: 820px;
    background: #fff;
    padding: 24px 18px 18px 18px;
    border-radius: 18px;
    max-height: 85vh;
    overflow: auto;
    margin: auto;
    position: relative;
    top: 10vh;
    box-shadow: 0 8px 32px var(--shadow);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }

  /* Status badges (consistent naming) */
  .status-badge {
    padding: 6px 14px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 13px;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    letter-spacing: 0.5px;
  }
  .s-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
  .s-inprogress { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  .s-resolved { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .s-deleted { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  .s-inactive { background: #e2e3e5; color: #495057; border: 1px solid #ced4da; }
  .s-queued { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

  .search-input { width: 320px; max-width: 100%; border: 1.5px solid var(--border); transition: border 0.2s; }
  .search-input:focus { border: 1.5px solid var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
  .small-muted { color: var(--muted); font-size: 13px; letter-spacing: 0.2px; }

  /* Modal content styling */
  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 12px 18px;
    margin: 16px 0;
  }
  .detail-grid .label {
    font-weight: 600;
    color: var(--muted);
  }
  .detail-section {
    margin: 16px 0;
  }
  .detail-section .label {
    font-weight: 600;
    color: var(--muted);
    display: block;
    margin-bottom: 8px;
  }
  .admin-logs {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }
  .log-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
  }
  .log-item:last-child {
    border-bottom: none;
  }

  @media (max-width: 900px) {
    .chart-container { height: 240px; }
    .list-container { overflow-x: auto; }
    .detail-grid {
      grid-template-columns: 1fr;
      gap: 8px;
    }
  }
</style>

</head>
<body>
  <div class="container">
    <div class="navbar">
      <div class="navbar-brand">
        <img src="gctu.png" class="logo" alt="logo">
        <div>
          <div style="font-weight:700" id="admin-title">QUEUEUP Admin</div>
          <div style="font-size:13px; color:var(--muted)">GCTU</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <button id="dark-mode-toggle" class="action-btn view-btn" title="Toggle dark mode" aria-label="Toggle dark mode">🌙</button>
        <button id="logout-btn" class="action-btn in-progress-btn">Log out</button>
      </div>
    </div>
    <div class="nav-tabs" role="tablist">
  <span class="nav-tab active" data-tab="dashboard">Dashboard Overview</span>
  <span class="nav-tab" data-tab="users">User Management</span>
  <span class="nav-tab" data-tab="complaints">Complaints</span>
  <span class="nav-tab" data-tab="inactive_complaints">Inactive</span>
  <span class="nav-tab" data-tab="result_issues">Result Issues</span>
  <span class="nav-tab" data-tab="admin_management" id="admin-management-tab" style="display:none;">Admin Management</span>
    </div>

    <div id="dashboard-content">
      <div class="dashboard-grid">
        <div class="card metric-card">
          <h3>Total Users</h3>
          <div id="total-users" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Queue Now</h3>
          <div id="queue-now" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Pending Complaints</h3>
          <div id="pending-complaints" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Unresolved Result Issues</h3>
          <div id="unresolved-result-issues" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Completed Queues</h3>
          <div id="completed-queues" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Active Users Online</h3>
          <div id="active-users" class="value">N/A</div>
        </div>
        <div class="card" style="grid-column:1 / -1">
          <h3>Recent Activity</h3>
          <div class="activity-log" style="height:160px; overflow:auto; padding-top:8px">
            <ul id="activity-log-list" style="list-style:none; padding:0; margin:0">
              <li class="small-muted">No recent activity.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>



    <div id="user-management-content" style="display:none;">
      <div class="card">
        <div class="list-header">
          <h3>All Users <span id="user-count" class="small-muted"></span></h3>
          <input class="search-input" id="user-search" placeholder="Search by name or ID...">
        </div>
        <div style="margin-top:12px; overflow:auto">
          <table class="list-table">
            <thead>
              <tr>
                <th data-sort="name">Name</th>
                <th data-sort="studentId">Student ID</th>
                <th data-sort="role">Role</th>
                <th data-sort="joinDate">Join Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="user-table-body"><tr><td colspan="5" class="small-muted">Loading users...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="complaints-content" style="display:none;">
      <div class="card">
        <div class="list-header">
          <h3>All Complaints <span id="complaints-count" class="small-muted"></span></h3>
          <div style="display:flex; gap:8px">
            <input class="search-input" id="complaints-search" placeholder="Search subject or student id...">
            <select id="complaints-filter"><option value="all">All</option><option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option><option value="deleted">Deleted</option></select>
          </div>
        </div>

        <div style="margin-top:12px; overflow:auto">
          <table class="list-table" id="complaints-table">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Student</th>
                <th>Type</th>
                <th>Status</th>
                <th>Admin Logs</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="complaints-table-body"><tr><td colspan="7" class="small-muted">Loading complaints...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="inactive-complaints-content" style="display:none;">
      <div class="card">
        <div class="list-header">
          <h3>Inactive Items</h3>
          <div class="small-muted">Complaints and result issues that have been marked as inactive. Items can be restored or permanently deleted.</div>
        </div>
        <div style="margin-top:12px; overflow:auto">
          <table class="list-table">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Item</th>
                <th>Type</th>
                <th>Date Submitted</th>
                <th>Inactive Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inactive-complaints-table-body"><tr><td colspan="6" class="small-muted">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="result_issues-content" style="display:none;">
      <div class="card">
        <div class="list-header">
          <h3>All Result Issues <span id="result-issues-count" class="small-muted"></span></h3>
          <div style="display:flex; gap:8px">
            <input class="search-input" id="result-search" placeholder="Search course or student id...">
            <select id="result-filter"><option value="all">All</option><option value="Queued">Queued</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option></select>
          </div>
        </div>

        <div style="margin-top:12px; overflow:auto">
          <table class="list-table" id="result-table">
            <thead>
              <tr>
                <th>Course</th>
                <th>Student</th>
                <th>Issue</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="result-table-body"><tr><td colspan="6" class="small-muted">Loading result issues...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="admin-management-content" style="display:none;">
      <div class="card">
        <div class="list-header">
          <h3>Admin Management</h3>
          <button id="create-admin-btn" class="action-btn in-progress-btn">Create New Admin</button>
        </div>
        <div style="margin-top:12px; overflow:auto">
          <table class="list-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Created Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="admin-table-body"><tr><td colspan="5" class="small-muted">Loading admins...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-content"></div>
    </div>
  </div>

  <script type="module">

    // Dark mode toggle logic
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    function setDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', '1');
        darkModeToggle.textContent = '☀️';
        darkModeToggle.setAttribute('aria-label', 'Switch to light mode');
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', '0');
        darkModeToggle.textContent = '🌙';
        darkModeToggle.setAttribute('aria-label', 'Switch to dark mode');
      }
    }
    darkModeToggle.addEventListener('click', () => {
      setDarkMode(!document.body.classList.contains('dark-mode'));
    });
    // On load, set mode from localStorage
    if (localStorage.getItem('darkMode') === '1') {
      setDarkMode(true);
    }
    else {
      setDarkMode(false);
    }
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDIqR0b9hA9IaLhRsVtJKSSwh9NktuIIjI",
      authDomain: "queueup-85662.firebaseapp.com",
      databaseURL: "https://queueup-85662-default-rtdb.firebaseio.com",
      projectId: "queueup-85662",
      storageBucket: "queueup-85662.firebasestorage.app",
      messagingSenderId: "647901471109",
      appId: "1:647901471109:web:2607f4883cd1393259e4ec"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---------- UI refs ----------
    const tabs = document.querySelectorAll('.nav-tab');
    const dashboardContent = document.getElementById('dashboard-content');
  // const queueContent = document.getElementById('queue-content');
    const userManagementContent = document.getElementById('user-management-content');
    const complaintsContent = document.getElementById('complaints-content');
    const inactiveComplaintsContent = document.getElementById('inactive-complaints-content');
    const resultIssuesContent = document.getElementById('result_issues-content');

    const logoutBtn = document.getElementById('logout-btn');

    // Dashboard elements
    const totalUsersEl = document.getElementById('total-users');
    const queueNowEl = document.getElementById('queue-now');
    const pendingComplaintsEl = document.getElementById('pending-complaints');
    const unresolvedResultIssuesEl = document.getElementById('unresolved-result-issues');
    const completedQueuesEl = document.getElementById('completed-queues');
    const activeUsersEl = document.getElementById('active-users');

    // Queue
  // const queueList = document.getElementById('queue-list');
  // const queueSearchInput = document.getElementById('queue-search');

    // Users
    const userSearchInput = document.getElementById('user-search');
    const userTableBody = document.getElementById('user-table-body');

    // Complaints
    const complaintsTableBody = document.getElementById('complaints-table-body');
    const complaintsSearchInput = document.getElementById('complaints-search');
    const complaintsFilterSelect = document.getElementById('complaints-filter');
    const complaintsCountEl = document.getElementById('complaints-count');

    // Inactive Complaints
    const inactiveComplaintsTableBody = document.getElementById('inactive-complaints-table-body');

    // Result issues
    const resultTableBody = document.getElementById('result-table-body');
    const resultSearchInput = document.getElementById('result-search');
    const resultFilterSelect = document.getElementById('result-filter');
    const resultCountEl = document.getElementById('result-issues-count');

    // Modals
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContentElement = modalBackdrop.querySelector('.modal-content');

    // Charts global (declare once)
  let queueSpeedChart = null, rolesDistributionChart = null;

    // Local cache
    let allUsersData = []; // array of {uid, ...}
    let allQueueData = [];
    let allComplaintsData = [];
    let allResultIssuesData = [];
    let allCompletedQueueData = [];
let combinedQueueData = [];

    // ---------- Auth & init ----------
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        console.warn('[ADMIN DEBUG] No user found, redirecting to admin.html');
        window.location.href = 'admin.html';
        return;
      }
      console.log('[ADMIN DEBUG] Logged in user:', user.uid);
      
      // Check admin status and role
      get(ref(db, `admins/${user.uid}`)).then(snap => {
        console.log('[ADMIN DEBUG] Admin data:', snap.exists() ? snap.val() : 'No data');
        if (!snap.exists() || snap.val().isAdmin !== true) {
          console.warn('[ADMIN DEBUG] Not admin or isAdmin not true, signing out in 5 seconds.');
          setTimeout(() => {
            signOut(auth);
            window.location.href = 'admin.html';
          }, 5000);
        } else {
          const adminData = snap.val();
          console.log('[ADMIN DEBUG] Admin check passed, role:', adminData.role);
          
          // Update navbar title to show admin role
          const adminTitleElement = document.getElementById('admin-title');
          if (adminTitleElement && adminData.role) {
            adminTitleElement.textContent = `QUEUEUP Admin (${adminData.role})`;
          }
          
          // Show admin management tab only for SuperAdmin
          if (adminData.role === 'SuperAdmin') {
            document.getElementById('admin-management-tab').style.display = 'block';
          }
          
          initDashboard();
          initUserManagement();
          initComplaints();
          initInactiveComplaints();
          initResultIssues();
          if (adminData.role === 'SuperAdmin') {
            initAdminManagement();
          }
          // Initialize charts only once after admin check passes
          initCharts();
        }
      }).catch(err => {
        console.error('[ADMIN DEBUG] admin check error', err, 'Signing out in 5 seconds.');
        setTimeout(() => {
          signOut(auth);
          window.location.href = 'admin.html';
        }, 5000);
      });
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'admin.html').catch(console.error);
    });

    // Tabs behavior
    tabs.forEach(tab => tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      // hide all

  dashboardContent.style.display = 'none';
  userManagementContent.style.display = 'none';
  complaintsContent.style.display = 'none';
  inactiveComplaintsContent.style.display = 'none';
  resultIssuesContent.style.display = 'none';
  const adminManagementContent = document.getElementById('admin-management-content');
  if (adminManagementContent) adminManagementContent.style.display = 'none';

      const tabName = tab.dataset.tab;
  if (tabName === 'dashboard') { dashboardContent.style.display = 'block'; initCharts(); }
  if (tabName === 'users') { userManagementContent.style.display = 'block'; renderUsers(allUsersData); }
  if (tabName === 'complaints') { complaintsContent.style.display = 'block'; renderComplaints(allComplaintsData); }
  if (tabName === 'inactive_complaints') { inactiveComplaintsContent.style.display = 'block'; renderInactiveComplaints(allComplaintsData); }
  if (tabName === 'result_issues') { resultIssuesContent.style.display = 'block'; renderResultIssues(allResultIssuesData); }
  if (tabName === 'admin_management' && adminManagementContent) { adminManagementContent.style.display = 'block'; renderAdmins(); }
    }));

// ---------- Dashboard & charts ----------
function initDashboard() {
  // Users
  onValue(ref(db, 'users'), (snap) => {
    const users = snap.val() || {};
    allUsersData = Object.entries(users).map(([uid, v]) => ({ uid, ...v }));
    totalUsersEl.textContent = allUsersData.length;
    console.log('[ADMIN DEBUG] Loaded users data:', allUsersData);
    // updateRolesDistribution removed (no longer needed)
  });

    // Queue (show number of unresolved complaints and result issues as 'queue now')
    const unresolvedComplaints = allComplaintsData.filter(c => c.status === 'pending' || c.status === 'Queued').length;
    const unresolvedResults = allResultIssuesData.filter(c => c.status === 'Queued' || c.status === 'in_progress').length;
    queueNowEl.textContent = unresolvedComplaints + unresolvedResults;

  // Complaints
  onValue(ref(db, 'complaints'), (snap) => {
    const complaints = snap.val() || {};
    allComplaintsData = Object.entries(complaints).map(([id, v]) => ({ id, ...v }));
    const pendingCount = allComplaintsData.filter(c => c.status === 'pending' || c.status === 'Queued').length;
    pendingComplaintsEl.textContent = pendingCount;
    complaintsCountEl.textContent = `(${allComplaintsData.length})`;

  });

  // Completed Queue
  onValue(ref(db, 'completed_queue'), (snap) => {
    const completed = snap.val() || {};
    allCompletedQueueData = Object.entries(completed).map(([id, v]) => ({ id, ...v }));
  completedQueuesEl.textContent = Object.keys(completed).length;
  });

  // Result Issues
  onValue(ref(db, 'result_issues'), (snap) => {
    const res = snap.val() || {};
    allResultIssuesData = Object.entries(res).map(([id, v]) => ({ id, ...v }));
    const unresolvedCount = allResultIssuesData.filter(c => c.status === 'Queued' || c.status === 'in_progress').length;
    unresolvedResultIssuesEl.textContent = unresolvedCount;
    resultCountEl.textContent = `(${allResultIssuesData.length})`;
  });

  // No more queue or complaint charts
  setupRealtimeActivityLog();
}


    // Initialize charts function
    function initCharts() {
      // Charts functionality can be added here in the future
      // For now, this prevents the ReferenceError
      console.log('[ADMIN DEBUG] Charts initialized (placeholder)');
    }


    // activity log & notification-like entries
    function addLog(message) {
      const list = document.getElementById('activity-log-list');
      if (!list) return;
      const li = document.createElement('li');
      li.className = 'small-muted';
      const t = new Date().toLocaleString();
      li.innerHTML = `<strong>${message}</strong> <div style="font-size:12px;color:var(--muted)">${t}</div>`;
      // append (show all activities, not just complaints)
      list.appendChild(li);
      // keep max 50
      while (list.children.length > 50) list.removeChild(list.firstChild);
    }

    function setupRealtimeActivityLog(){
      // Only log new complaints
      onValue(ref(db,'complaints'), (snap) => {
        const obj = snap.val() || {};
        const arr = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
        const oldIds = allComplaintsData.map(x => x.id);
        arr.forEach(item => { if (!oldIds.includes(item.id)) addLog(`New complaint: ${item.subject || item.description || 'Complaint'}`); });
        allComplaintsData = arr;
      });
    }

    // All queue logic removed

    // ---------- User management ----------
    function initUserManagement(){
      onValue(ref(db,'users'), (snap)=> {
        const users = snap.val() || {};
        allUsersData = Object.entries(users).map(([uid, v]) => ({ uid, ...v }));
        console.log('[ADMIN DEBUG] User management - loaded users:', allUsersData);
        renderUsers(allUsersData);
      });
      userSearchInput.addEventListener('input', ()=> renderUsers(allUsersData));
    }

    function renderUsers(users){
      userTableBody.innerHTML='';
      const term = (userSearchInput.value||'').toLowerCase();
      const filtered = users.filter(u => {
        const name = u.name || u.full_name || '';
        const sid = u.studentId || u.studentID || '';
        return name.toLowerCase().includes(term) || (sid+'').toLowerCase().includes(term);
      });
      document.getElementById('user-count').textContent = `(${filtered.length})`;
      if (!filtered.length) {
        userTableBody.innerHTML = '<tr><td colspan="5" class="small-muted">No users found.</td></tr>'; return;
      }
      filtered.forEach(u=>{
        const join = u.timestamp ? new Date(u.timestamp).toLocaleDateString() : 'N/A';
        const name = u.name || u.full_name || 'N/A';
        const sid = u.studentId || u.studentID || 'N/A';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(sid)}</td><td>${escapeHtml(u.role||'Student')}</td><td>${join}</td><td><button class="action-btn view-btn" data-user-id="${u.uid}">View</button></td>`;
        const viewBtn = tr.querySelector('.view-btn');
        if (viewBtn) {
          viewBtn.addEventListener('click', () => showStudentProfileModal(u));
        }
        userTableBody.appendChild(tr);
      });
    }

   // ---------- Complaints management ----------
function initComplaints(){
  onValue(ref(db,'complaints'), (snap) => {
    const obj = snap.val() || {};
    // complaints are already flat
    allComplaintsData = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
    renderComplaints(allComplaintsData);
  });
  complaintsSearchInput.addEventListener('input', ()=> renderComplaints(allComplaintsData));
  complaintsFilterSelect.addEventListener('change', ()=> renderComplaints(allComplaintsData));
}

function renderComplaints(arr){
  const term = (complaintsSearchInput.value||'').toLowerCase();
  const filter = complaintsFilterSelect.value;
  
  // Remove duplicates: keep only one complaint per id, prefer those with a real student_id
  const uniqueMap = {};
  arr.forEach(item => {
    if (!uniqueMap[item.id] || (item.student_id && item.student_id !== 'Unknown')) {
      uniqueMap[item.id] = item;
    }
  });
  const filtered = Object.values(uniqueMap).filter(item => {
    // Optionally, skip items with student_id 'Unknown'
    if (!item.student_id || item.student_id === 'Unknown') return false;
    const subject = (item.subject || item.description || '').toLowerCase();
    const sid = (item.student_id || '').toString().toLowerCase();
    const matches = subject.includes(term) || sid.includes(term);
    const status = (item.status||'').toLowerCase();
    const statusMatch = (filter==='all') || (status === filter) || (filter==='pending' && (status==='pending' || status==='queued'));
    return matches && statusMatch;
  });

  complaintsTableBody.innerHTML='';
  complaintsCountEl.textContent = `(${filtered.length})`;

  if (!filtered.length) {
    complaintsTableBody.innerHTML = '<tr><td colspan="7" class="small-muted">No complaints found.</td></tr>';
    return;
  }

  filtered.sort((a,b)=> (b.date_submitted||0)-(a.date_submitted||0));

    filtered.forEach(c=>{
    const date = c.date_submitted ? new Date(c.date_submitted).toLocaleString() : 'N/A';
    const statusClass = `s-${(c.status||'pending').replace(/\s+/g,'_')}`;
    const stu = c.student_id || 'Unknown';
    const logs = c.admin_logs ? c.admin_logs.join('<br>') : 'No logs';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(c.subject||c.text||c.description||'Complaint')}</td>
      <td>${escapeHtml(stu)}</td>
      <td>${escapeHtml(c.type || 'General')}</td>
      <td><span class="status-badge ${statusClass}">${escapeHtml(c.status||'pending')}</span></td>
      <td>${logs}</td>
      <td>${escapeHtml(date)}</td>
      <td>
        <button class="action-btn view-btn" data-complaint-id="${c.id}">View</button>
        <button class="action-btn in-progress-btn" data-action="in_progress" data-id="${c.id}" data-student="${stu}">In Progress</button>
        <button class="action-btn done-btn" data-action="resolved" data-id="${c.id}" data-student="${stu}">Resolve</button>
        <button class="action-btn escalate-btn" data-action="delete" data-id="${c.id}" data-student="${stu}">Delete</button>
      </td>`;
    
    // Attach event listeners
    const viewBtn = tr.querySelector('.view-btn');
    viewBtn.addEventListener('click', () => showComplaintDetails(c));
    
    const actionBtns = tr.querySelectorAll('.action-btn[data-action]');
    actionBtns.forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const action = e.currentTarget.dataset.action;
        const studentId = e.currentTarget.dataset.student;
        
        if (!id) {
          console.error('Complaint ID is undefined for action:', action);
          showToast('Error: Invalid complaint ID', 'error');
          return;
        }
        
        if (action === 'delete') {
          deleteComplaint(id, studentId);
          // Switch to inactive tab after deletion
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelector('.nav-tab[data-tab="inactive_complaints"]').classList.add('active');
          dashboardContent.style.display = 'none';
          userManagementContent.style.display = 'none';
          complaintsContent.style.display = 'none';
          inactiveComplaintsContent.style.display = 'block';
          resultIssuesContent.style.display = 'none';
        } else {
          setComplaintStatus(id, studentId, action);
        }
      });
    });
    
    complaintsTableBody.appendChild(tr);
  });
}

function setComplaintStatus(complaintId, studentId, newStatus) {
  // Validate inputs
  if (!complaintId) {
    console.error('Complaint ID is undefined');
    showToast('Error: Invalid complaint ID', 'error');
    return;
  }
  
  // Get current user info
  const currentUser = auth.currentUser;
  const adminName = currentUser ? currentUser.email.split('@')[0] : 'Unknown Admin';
  const timestamp = new Date().toISOString();
  
  // Add admin log entry
  const logEntry = `${adminName} changed status to ${newStatus} at ${timestamp}`;
  
  // Get current complaint data first to preserve existing admin_logs
  get(ref(db, `complaints/${complaintId}`)).then(snap => {
    if (snap.exists()) {
      const currentData = snap.val();
      const existingLogs = currentData.admin_logs || [];
      
      // Update flat path
      const updates = {
        status: newStatus,
        admin_logs: [...existingLogs, logEntry],
        updated_at: timestamp
      };
      
      // If marking as inactive, add inactive timestamp
      if (newStatus === 'inactive') {
        updates.inactive_date = timestamp;
      }
      
      update(ref(db, `complaints/${complaintId}`), updates).then(() => {
        const statusMessage = newStatus === 'inactive' ? 'Complaint moved to inactive' : `Complaint status updated to ${newStatus}`;
        showToast(statusMessage, 'success');
      }).catch(err => {
        console.error('Error updating complaint:', err);
        showToast('Error updating complaint status', 'error');
      });
      
      // Update per-student path to reflect status change
      if (studentId && studentId !== 'Unknown') {
        // Update student's complaint tracking
        updateStudentComplaintStatus(studentId, complaintId, newStatus, timestamp);
      }
    } else {
      console.error('Complaint not found:', complaintId);
      showToast('Error: Complaint not found', 'error');
    }
  }).catch(err => {
    console.error('Error fetching complaint:', err);
    showToast('Error fetching complaint data', 'error');
  });
}

// Function to update student's complaint tracking
function updateStudentComplaintStatus(studentId, complaintId, newStatus, timestamp) {
  // Update in student's complaints path
  get(ref(db, `complaints/${studentId}`)).then(snap => {
    if (snap.exists()) {
      Object.entries(snap.val()).forEach(([pushId, obj]) => {
        if (obj && obj.id === complaintId) {
          const updates = {
            status: newStatus,
            updated_at: timestamp
          };
          if (newStatus === 'inactive') {
            updates.inactive_date = timestamp;
          }
          update(ref(db, `complaints/${studentId}/${pushId}`), updates);
        }
      });
    }
  });
  
  // Also update in student's tracking/status path if it exists
  const trackingPath = `student_tracking/${studentId}/complaints/${complaintId}`;
  update(ref(db, trackingPath), {
    status: newStatus,
    updated_at: timestamp,
    ...(newStatus === 'inactive' && { inactive_date: timestamp })
  }).catch(err => {
    console.log('Student tracking path may not exist, which is normal:', err.message);
  });
}

function deleteComplaint(complaintId, studentId) {
  // Mark as inactive instead of deleted and add deletion log
  const currentUser = auth.currentUser;
  const adminName = currentUser ? currentUser.email.split('@')[0] : 'Unknown Admin';
  const timestamp = new Date().toISOString();
  
  // Get current complaint data first to preserve existing admin_logs
  get(ref(db, `complaints/${complaintId}`)).then(snap => {
    if (snap.exists()) {
      const currentData = snap.val();
      const existingLogs = currentData.admin_logs || [];
      
      // Add deletion log entry
      const deletionLogEntry = `${adminName} moved complaint to inactive (deleted) at ${timestamp}`;
      
      // Update with inactive status and deletion log
      const updates = {
        status: 'inactive',
        admin_logs: [...existingLogs, deletionLogEntry],
        inactive_date: timestamp,
        updated_at: timestamp
      };
      
      update(ref(db, `complaints/${complaintId}`), updates).then(() => {
        showToast('Complaint moved to inactive', 'success');
      }).catch(err => {
        console.error('Error updating complaint:', err);
        showToast('Error moving complaint to inactive', 'error');
      });
      
      // Update per-student path
      if (studentId && studentId !== 'Unknown') {
        updateStudentComplaintStatus(studentId, complaintId, 'inactive', timestamp);
      }
    }
  }).catch(err => {
    console.error('Error fetching complaint for deletion:', err);
    showToast('Error processing complaint deletion', 'error');
  });
}

function showComplaintDetails(complaint) {
  const studentUser = allUsersData.find(u => (u.studentId === complaint.student_id || u.studentID === complaint.student_id || u.student_id === complaint.student_id));

  let modalContent = `
    <div class="modal-header">
      <h3>Complaint Details</h3>
      <button onclick="closeModal()" class="action-btn view-btn" style="border:none;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div><span class="label">Subject</span><span>${escapeHtml(complaint.subject || complaint.text || complaint.description || 'N/A')}</span></div>
        <div><span class="label">Type</span><span>${escapeHtml(complaint.type || 'N/A')}</span></div>
        <div><span class="label">Status</span><span><span class="status-badge s-${(complaint.status||'pending').replace(/\s+/g,'_')}">${escapeHtml(complaint.status || 'pending')}</span></span></div>
        <div><span class="label">Date Submitted</span><span>${complaint.date_submitted ? new Date(complaint.date_submitted).toLocaleString() : 'N/A'}</span></div>
      </div>
      <div class="detail-section">
        <span class="label">Description</span>
        <p>${escapeHtml(complaint.text || complaint.description || 'No description provided')}</p>
      </div>
      <hr>`;

  if (studentUser) {
    const mappedUser = mapUserFields(studentUser);
    modalContent += `
      <h3>Student Information</h3>
      <div class="detail-grid">
        <div><span class="label">Full Name</span><span>${escapeHtml(mappedUser.fullName)}</span></div>
        <div><span class="label">Student ID</span><span>${escapeHtml(mappedUser.studentId)}</span></div>
        <div><span class="label">Email</span><span>${escapeHtml(mappedUser.email)}</span></div>
        <div><span class="label">Faculty</span><span>${escapeHtml(mappedUser.faculty)}</span></div>
        <div><span class="label">Group</span><span>${escapeHtml(mappedUser.group)}</span></div>
        <div><span class="label">Programme</span><span>${escapeHtml(mappedUser.programme)}</span></div>
        <div><span class="label">Level</span><span>${escapeHtml(mappedUser.level)}</span></div>
        <div><span class="label">Semester</span><span>${escapeHtml(mappedUser.semester)}</span></div>
        <div><span class="label">Session</span><span>${escapeHtml(mappedUser.session)}</span></div>
      </div>
      <hr>`;
  } else {
    modalContent += `
      <h3>Student Information</h3>
      <div class="detail-grid">
        <div><span class="label">Student ID</span><span>${escapeHtml(complaint.student_id || 'N/A')}</span></div>
      </div>
      <p class="small-muted">Full student profile not found.</p>
      <hr>`;
  }

  modalContent += `
      <h3>Admin Logs</h3>
      <div class="admin-logs">
        ${complaint.admin_logs && Array.isArray(complaint.admin_logs) ? complaint.admin_logs.map(log => {
          if (typeof log === 'string') {
            return `<div class="log-item">${escapeHtml(log)}</div>`;
          } else if (log && typeof log === 'object') {
            return `<div class="log-item"><strong>${escapeHtml(log.admin || 'Admin')}</strong> changed status to <em>${escapeHtml(log.status || 'unknown')}</em> on ${log.timestamp ? new Date(log.timestamp).toLocaleString() : 'unknown date'}</div>`;
          }
          return '';
        }).join('') : '<p class="small-muted">No admin activity yet.</p>'}
      </div>
    </div>`;

  openModal(modalContent);
}

function updateComplaintStatus(complaintId) {
  const newStatus = document.getElementById('status-changer').value;
  setComplaintStatus(complaintId, null, newStatus);
  closeModal();
}

    // ---------- Inactive Complaints management ----------
function initInactiveComplaints(){
  // Load inactive complaints and result issues
  onValue(ref(db, 'complaints'), (snap) => {
    const obj = snap.val() || {};
    const complaints = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
    renderInactiveComplaints(complaints);
  });
  
  // Also listen to result issues for inactive items
  onValue(ref(db, 'result_issues'), (snap) => {
    const obj = snap.val() || {};
    const resultIssues = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
    // Update allResultIssuesData for inactive rendering
    allResultIssuesData = resultIssues;
    // Re-render inactive items if tab is active
    const inactiveTab = document.querySelector('.nav-tab[data-tab="inactive_complaints"]');
    if (inactiveTab && inactiveTab.classList.contains('active')) {
      renderInactiveComplaints(allComplaintsData);
    }
  });
}

function renderInactiveComplaints(complaints = []) {
  // Filter complaints and result issues that are inactive
  const inactiveComplaints = complaints.filter(c => c.status === 'inactive');
  
  // Also get inactive result issues
  const inactiveResultIssues = allResultIssuesData.filter(r => r.status === 'inactive');
  
  // Combine both types
  const allInactiveItems = [
    ...inactiveComplaints.map(c => ({ ...c, type: 'complaint' })),
    ...inactiveResultIssues.map(r => ({ ...r, type: 'result_issue' }))
  ];

  inactiveComplaintsTableBody.innerHTML = '';
  
  if (!allInactiveItems.length) {
    inactiveComplaintsTableBody.innerHTML = '<tr><td colspan="6" class="small-muted">No inactive items found.</td></tr>';
    return;
  }

  // Sort by inactive date (most recent first)
  allInactiveItems.sort((a, b) => {
    const dateA = a.inactive_date || a.date_submitted || 0;
    const dateB = b.inactive_date || b.date_submitted || 0;
    return new Date(dateB) - new Date(dateA);
  });

  allInactiveItems.forEach(item => {
    const date = item.date_submitted ? new Date(item.date_submitted).toLocaleString() : 'N/A';
    const inactiveDate = item.inactive_date ? new Date(item.inactive_date).toLocaleString() : 'N/A';
    const statusClass = `s-inactive`;
    const stu = item.student_id || 'Unknown';
    const itemType = item.type === 'complaint' ? 'Complaint' : 'Result Issue';
    const itemTitle = item.type === 'complaint' ? 
      (item.subject || item.description || 'Complaint') : 
      (item.course_code || item.description || 'Result Issue');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(stu)}</td>
      <td>${escapeHtml(itemTitle)}</td>
      <td>${escapeHtml(itemType)}</td>
      <td>${escapeHtml(date)}</td>
      <td>${escapeHtml(inactiveDate)}</td>
      <td>
        <button class="action-btn view-btn" data-action="restore" data-id="${item.id}" data-student="${stu}" data-type="${item.type}">Restore</button>
      </td>`;
    
    const actionBtns = tr.querySelectorAll('.action-btn');
    actionBtns.forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const action = e.currentTarget.dataset.action;
        const studentId = e.currentTarget.dataset.student;
        const itemType = e.currentTarget.dataset.type;
        
        if (action === 'restore') {
          if (itemType === 'complaint') {
            setComplaintStatus(id, studentId, 'pending');
          } else {
            setResultIssueStatus(id, studentId, 'Queued');
          }
        }
      });
    });
    
    inactiveComplaintsTableBody.appendChild(tr);
  });
}

function permanentlyDeleteComplaint(complaintId, studentId) {
  if (!confirm('Are you sure you want to permanently delete this complaint? This action cannot be undone.')) {
    return;
  }
  
  // Remove from flat path
  update(ref(db), {
    [`complaints/${complaintId}`]: null
  }).then(() => {
    showToast('Complaint permanently deleted', 'success');
  }).catch(err => {
    console.error('Error deleting complaint:', err);
    showToast('Error deleting complaint', 'error');
  });
  
  // Remove from per-student path
  if (studentId && studentId !== 'Unknown') {
    get(ref(db, `complaints/${studentId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([pushId, obj]) => {
          if (obj && obj.id === complaintId) {
            update(ref(db), { [`complaints/${studentId}/${pushId}`]: null });
          }
        });
      }
    });
    
    // Remove from student tracking
    update(ref(db), { [`student_tracking/${studentId}/complaints/${complaintId}`]: null });
  }
}

function permanentlyDeleteResultIssue(issueId, studentId) {
  if (!confirm('Are you sure you want to permanently delete this result issue? This action cannot be undone.')) {
    return;
  }
  
  // Remove from flat path
  update(ref(db), {
    [`result_issues/${issueId}`]: null
  }).then(() => {
    showToast('Result issue permanently deleted', 'success');
  }).catch(err => {
    console.error('Error deleting result issue:', err);
    showToast('Error deleting result issue', 'error');
  });
  
  // Remove from per-student path
  if (studentId && studentId !== 'Unknown') {
    get(ref(db, `results_issues/${studentId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([pushId, obj]) => {
          if (obj && obj.id === issueId) {
            update(ref(db), { [`results_issues/${studentId}/${pushId}`]: null });
          }
        });
      }
    });
    
    // Remove from student tracking
    update(ref(db), { [`student_tracking/${studentId}/result_issues/${issueId}`]: null });
  }
}


    // ---------- Result Issues management ----------
function initResultIssues(){
  onValue(ref(db, 'result_issues'), (snap) => {
    const obj = snap.val() || {};
    // already flat
    allResultIssuesData = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
    renderResultIssues(allResultIssuesData);
  });
  resultSearchInput.addEventListener('input', () => renderResultIssues(allResultIssuesData));
  resultFilterSelect.addEventListener('change', () => renderResultIssues(allResultIssuesData));
}

function renderResultIssues(arr){
  const term = (resultSearchInput.value||'').toLowerCase();
  const filter = resultFilterSelect.value;

  const filtered = arr.filter(item => {
    const course = (item.course_code || '').toLowerCase();
    const sid = (item.student_id || '').toLowerCase();
    const matches = course.includes(term) || sid.includes(term);
    const status = (item.status||'').toLowerCase();
    const statusMatch = (filter==='all') || (status === filter);
    return matches && statusMatch;
  });

  resultTableBody.innerHTML = '';
  resultCountEl.textContent = `(${filtered.length})`;

  if (!filtered.length) {
    resultTableBody.innerHTML = '<tr><td colspan="6" class="small-muted">No result issues found.</td></tr>';
    return;
  }

  filtered.sort((a,b)=> (b.date_submitted||0)-(a.date_submitted||0));

  filtered.forEach(issue => {
    const date = issue.date_submitted ? new Date(issue.date_submitted).toLocaleString() : 'N/A';
    const statusClass = `s-${(issue.status||'Queued').replace(/\s+/g,'_')}`;
    const stu = issue.student_id || 'Unknown';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(issue.course_code||'N/A')}</td>
      <td>${escapeHtml(stu)}</td>
      <td>${escapeHtml(issue.description||'N/A')}</td>
      <td><span class="status-badge ${statusClass}">${escapeHtml(issue.status||'Queued')}</span></td>
      <td>${escapeHtml(date)}</td>
      <td>
        <button class="action-btn view-btn" data-issue-id="${issue.id}">View</button>
        <button class="action-btn in-progress-btn" data-action="in_progress" data-id="${issue.id}" data-student="${stu}">In Progress</button>
        <button class="action-btn done-btn" data-action="resolved" data-id="${issue.id}" data-student="${stu}">Resolve</button>
        <button class="action-btn escalate-btn" data-action="delete" data-id="${issue.id}" data-student="${stu}">Delete</button>
      </td>`;
    
    // Attach event listeners
    const viewBtn = tr.querySelector('.view-btn');
    viewBtn.addEventListener('click', () => showResultIssueDetails(issue));
    
    const actionBtns = tr.querySelectorAll('.action-btn[data-action]');
    actionBtns.forEach(btn => {
      btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const action = e.currentTarget.dataset.action;
        const studentId = e.currentTarget.dataset.student;
        
        if (!id) {
          console.error('Result issue ID is undefined for action:', action);
          showToast('Error: Invalid result issue ID', 'error');
          return;
        }
        
        if (action === 'delete') {
          deleteResultIssue(id, studentId);
          // Switch to inactive tab after deletion
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelector('.nav-tab[data-tab="inactive_complaints"]').classList.add('active');
          dashboardContent.style.display = 'none';
          userManagementContent.style.display = 'none';
          complaintsContent.style.display = 'none';
          inactiveComplaintsContent.style.display = 'block';
          resultIssuesContent.style.display = 'none';
        } else {
          setResultIssueStatus(id, studentId, action);
        }
      });
    });
    
    resultTableBody.appendChild(tr);
  });
}

function setResultIssueStatus(issueId, studentId, newStatus) {
  // Validate inputs
  if (!issueId) {
    console.error('Result issue ID is undefined');
    showToast('Error: Invalid result issue ID', 'error');
    return;
  }
  
  const timestamp = new Date().toISOString();
  const updates = {
    status: newStatus,
    updated_at: timestamp
  };
  
  // If marking as inactive, add inactive timestamp
  if (newStatus === 'inactive') {
    updates.inactive_date = timestamp;
  }
  
  // Update flat path
  update(ref(db, `result_issues/${issueId}`), updates).then(() => {
    const statusMessage = newStatus === 'inactive' ? 'Result issue moved to inactive' : `Result issue status updated to ${newStatus}`;
    showToast(statusMessage, 'success');
  }).catch(err => {
    console.error('Error updating result issue:', err);
    showToast('Error updating result issue status', 'error');
  });
  
  // Update per-student path
  if (studentId && studentId !== 'Unknown') {
    // Update student's result issue tracking
    updateStudentResultIssueStatus(studentId, issueId, newStatus, timestamp);
  }
}

// Function to update student's result issue tracking
function updateStudentResultIssueStatus(studentId, issueId, newStatus, timestamp) {
  // Update in student's result issues path
  get(ref(db, `results_issues/${studentId}`)).then(snap => {
    if (snap.exists()) {
      Object.entries(snap.val()).forEach(([pushId, obj]) => {
        if (obj && obj.id === issueId) {
          const updates = {
            status: newStatus,
            updated_at: timestamp
          };
          if (newStatus === 'inactive') {
            updates.inactive_date = timestamp;
          }
          update(ref(db, `results_issues/${studentId}/${pushId}`), updates);
        }
      });
    }
  }).catch(err => {
    console.error('Error updating student result issue:', err);
  });
  
  // Also update in student's tracking/status path if it exists
  const trackingPath = `student_tracking/${studentId}/result_issues/${issueId}`;
  update(ref(db, trackingPath), {
    status: newStatus,
    updated_at: timestamp,
    ...(newStatus === 'inactive' && { inactive_date: timestamp })
  }).catch(err => {
    console.log('Student tracking path may not exist, which is normal:', err.message);
  });
}

function deleteResultIssue(issueId, studentId) {
  // Mark as inactive instead of archiving and add deletion log
  const currentUser = auth.currentUser;
  const adminName = currentUser ? currentUser.email.split('@')[0] : 'Unknown Admin';
  const timestamp = new Date().toISOString();
  
  // Get current result issue data first
  get(ref(db, `result_issues/${issueId}`)).then(snap => {
    if (snap.exists()) {
      const currentData = snap.val();
      
      // Update with inactive status and deletion info
      const updates = {
        status: 'inactive',
        inactive_date: timestamp,
        updated_at: timestamp,
        deleted_by: adminName,
        deletion_reason: 'Moved to inactive by admin'
      };
      
      update(ref(db, `result_issues/${issueId}`), updates).then(() => {
        showToast('Result issue moved to inactive', 'success');
      }).catch(err => {
        console.error('Error updating result issue:', err);
        showToast('Error moving result issue to inactive', 'error');
      });
      
      // Update per-student path
      if (studentId && studentId !== 'Unknown') {
        updateStudentResultIssueStatus(studentId, issueId, 'inactive', timestamp);
      }
    }
  }).catch(err => {
    console.error('Error fetching result issue for deletion:', err);
    showToast('Error processing result issue deletion', 'error');
  });
  
  // Refresh inactive complaints view if it's currently open
  setTimeout(() => {
    const inactiveTab = document.querySelector('.nav-tab[data-tab="inactive_complaints"]');
    if (inactiveTab && inactiveTab.classList.contains('active')) {
      renderInactiveComplaints(allComplaintsData);
    }
  }, 500);
}

function showResultIssueDetails(issue) {
  const studentUser = allUsersData.find(u => (u.studentId === issue.student_id || u.studentID === issue.student_id || u.student_id === issue.student_id));

  let modalContent = `
    <div class="modal-header">
      <h3>Result Issue Details</h3>
      <button onclick="closeModal()" class="action-btn view-btn" style="border:none;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div><span class="label">Course Code</span><span>${escapeHtml(issue.course_code || 'N/A')}</span></div>
        <div><span class="label">Status</span><span><span class="status-badge s-${(issue.status||'Queued').replace(/\s+/g,'_')}">${escapeHtml(issue.status || 'Queued')}</span></span></div>
        <div><span class="label">Date Submitted</span><span>${issue.date_submitted ? new Date(issue.date_submitted).toLocaleString() : 'N/A'}</span></div>
      </div>
      <div class="detail-section">
        <span class="label">Issue Description</span>
        <p>${escapeHtml(issue.description || 'No description provided')}</p>
      </div>
      <hr>`;

  if (studentUser) {
    const mappedUser = mapUserFields(studentUser);
    modalContent += `
      <h3>Student Information</h3>
      <div class="detail-grid">
        <div><span class="label">Full Name</span><span>${escapeHtml(mappedUser.fullName)}</span></div>
        <div><span class="label">Student ID</span><span>${escapeHtml(mappedUser.studentId)}</span></div>
        <div><span class="label">Email</span><span>${escapeHtml(mappedUser.email)}</span></div>
        <div><span class="label">Faculty</span><span>${escapeHtml(mappedUser.faculty)}</span></div>
        <div><span class="label">Group</span><span>${escapeHtml(mappedUser.group)}</span></div>
        <div><span class="label">Programme</span><span>${escapeHtml(mappedUser.programme)}</span></div>
        <div><span class="label">Level</span><span>${escapeHtml(mappedUser.level)}</span></div>
        <div><span class="label">Semester</span><span>${escapeHtml(mappedUser.semester)}</span></div>
        <div><span class="label">Session</span><span>${escapeHtml(mappedUser.session)}</span></div>
      </div>`;
  } else {
    modalContent += `
      <h3>Student Information</h3>
      <div class="detail-grid">
        <div><span class="label">Student ID</span><span>${escapeHtml(issue.student_id || 'N/A')}</span></div>
      </div>
      <p class="small-muted">Full student profile not found.</p>`;
  }

  modalContent += `</div>`;

  openModal(modalContent);
}

function updateResultIssueStatus(issueId) {
  const newStatus = document.getElementById('status-changer').value;
  setResultIssueStatus(issueId, null, newStatus);
  closeModal();
}

    // ---------- Modals ----------
    function openModal(htmlContent) {
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalContentElement = modalBackdrop.querySelector('.modal-content');
      modalContentElement.innerHTML = htmlContent;
      modalBackdrop.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      modalBackdrop.setAttribute('aria-hidden', 'false');
      setTimeout(() => {
        modalBackdrop.addEventListener('click', backdropClickHandler);
      }, 50);
    }
    function backdropClickHandler(e) {
      const modalBackdrop = document.getElementById('modalBackdrop');
      if (e.target === modalBackdrop) closeModal();
    }
    function closeModal() {
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalContent = modalBackdrop.querySelector('.modal-content');
      modalBackdrop.style.display = 'none';
      document.body.style.overflow = '';
      modalBackdrop.setAttribute('aria-hidden', 'true');
      modalContent.innerHTML = '';
      modalBackdrop.removeEventListener('click', backdropClickHandler);
    }
    window.closeModal = closeModal;

  function showStudentProfileModal(studentUser) {
    if (!studentUser) {
      showToast('Could not find user details.', 'error');
      return;
    }

    console.log('[ADMIN DEBUG] Showing profile for user:', studentUser);

    // Map Firebase fields to display fields
    const mappedUser = mapUserFields(studentUser);

    const modalContent = `
      <div class="modal-header">
        <h3>Student Profile</h3>
        <button onclick="closeModal()" class="action-btn view-btn" style="border:none;">&times;</button>
      </div>
      <div class="modal-body">
        <h4>Personal Information</h4>
        <div class="detail-grid">
          <div><span class="label">Full Name</span><span>${escapeHtml(mappedUser.fullName)}</span></div>
          <div><span class="label">Email</span><span>${escapeHtml(mappedUser.email)}</span></div>
        </div>
        <h4>Academic Information</h4>
        <div class="detail-grid">
          <div><span class="label">Student ID</span><span>${escapeHtml(mappedUser.studentId)}</span></div>
          <div><span class="label">Faculty</span><span>${escapeHtml(mappedUser.faculty)}</span></div>
          <div><span class="label">Group</span><span>${escapeHtml(mappedUser.group)}</span></div>
          <div><span class="label">Programme</span><span>${escapeHtml(mappedUser.programme)}</span></div>
          <div><span class="label">Level</span><span>${escapeHtml(mappedUser.level)}</span></div>
          <div><span class="label">Semester</span><span>${escapeHtml(mappedUser.semester)}</span></div>
          <div><span class="label">Session</span><span>${escapeHtml(mappedUser.session)}</span></div>
        </div>
      </div>
    `;
    openModal(modalContent);
  }

  // Function to map Firebase user fields to display fields
  function mapUserFields(user) {
    console.log('[ADMIN DEBUG] Mapping user fields:', user);
    return {
      fullName: user.full_name || user.name || 'N/A',
      email: user.email || 'N/A',
      studentId: user.studentId || user.studentID || user.student_id || 'N/A',
      faculty: user.faculty || 'N/A', // Use faculty field directly
      group: user.department || user.group || user.student_group || 'N/A', // department contains group info
      programme: user.programme || user.program || user.course || 'N/A',
      level: user.level || user.academic_year || 'N/A',
      semester: user.semester || user.current_semester || 'N/A',
      session: user.session || user.time_session || 'N/A'
    };
  }

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type) {
  // Simple toast implementation
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.padding = '12px 20px';
  toast.style.borderRadius = '8px';
  toast.style.color = '#fff';
  toast.style.backgroundColor = type === 'error' ? '#dc3545' : '#28a745';
  toast.style.zIndex = '9999';
  toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// ---------- Admin Management ----------
let allAdminsData = [];

function initAdminManagement() {
  onValue(ref(db, 'admins'), (snap) => {
    const admins = snap.val() || {};
    allAdminsData = Object.entries(admins).map(([uid, data]) => ({ uid, ...data }));
    console.log('[ADMIN DEBUG] Loaded admins:', allAdminsData);
    renderAdmins();
  });
  
  // Create admin button handler
  document.getElementById('create-admin-btn').addEventListener('click', showCreateAdminModal);
}

function renderAdmins() {
  const adminTableBody = document.getElementById('admin-table-body');
  if (!adminTableBody) return;
  
  adminTableBody.innerHTML = '';
  
  if (!allAdminsData.length) {
    adminTableBody.innerHTML = '<tr><td colspan="5" class="small-muted">No admins found.</td></tr>';
    return;
  }
  
  allAdminsData.forEach(admin => {
    const createdDate = admin.createdAt ? new Date(admin.createdAt).toLocaleDateString() : 'N/A';
    const status = admin.isAdmin ? 'Active' : 'Inactive';
    const statusClass = admin.isAdmin ? 's-resolved' : 's-pending';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(admin.email || admin.uid)}</td>
      <td>${escapeHtml(admin.role || 'Admin')}</td>
      <td>${createdDate}</td>
      <td><span class="status-badge ${statusClass}">${status}</span></td>
      <td>
        <button class="action-btn view-btn" onclick="editAdmin('${admin.uid}')">Edit</button>
        ${admin.role !== 'SuperAdmin' ? `<button class="action-btn escalate-btn" onclick="deleteAdmin('${admin.uid}')">Delete</button>` : ''}
      </td>
    `;
    adminTableBody.appendChild(tr);
  });
}

function showCreateAdminModal() {
  const modalContent = `
    <div class="modal-header">
      <h3>Create New Admin</h3>
      <button onclick="closeModal()" class="action-btn view-btn" style="border:none;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div><span class="label">Email</span><input type="email" id="admin-email" placeholder="admin@gctu.edu.gh" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;"></div>
        <div><span class="label">Role</span>
          <select id="admin-role" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;">
            <option value="Admin">Admin</option>
            <option value="HOD">Head of Department</option>
            <option value="Exam Officer">Exam Officer</option>
            <option value="Dean">Dean</option>
            <option value="Registrar">Registrar</option>
          </select>
        </div>
        <div><span class="label">Temporary Password</span><input type="password" id="admin-password" placeholder="Temporary password" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;"></div>
      </div>
      <div style="margin-top:20px;">
        <button class="action-btn in-progress-btn" onclick="createAdmin()">Create Admin</button>
        <button class="action-btn view-btn" onclick="closeModal()" style="margin-left:10px;">Cancel</button>
      </div>
    </div>
  `;
  openModal(modalContent);
}

async function createAdmin() {
  const email = document.getElementById('admin-email').value.trim();
  const role = document.getElementById('admin-role').value;
  const password = document.getElementById('admin-password').value.trim();
  
  if (!email || !role || !password) {
    showToast('Please fill all fields', 'error');
    return;
  }
  
  if (password.length < 6) {
    showToast('Password must be at least 6 characters long', 'error');
    return;
  }
  
  // Store current user info before creating new admin
  const currentUser = auth.currentUser;
  const currentUserEmail = currentUser.email;
  
  try {
    // Create Firebase Auth user account
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const newUser = userCredential.user;
    
    // Create admin record in database using the actual Firebase Auth UID
    const adminData = {
      email: email,
      role: role,
      isAdmin: true,
      createdAt: new Date().toISOString(),
      createdBy: currentUser.uid
    };
    
    await update(ref(db, `admins/${newUser.uid}`), adminData);
    
    // Sign out the newly created user and sign back in the original admin
    await signOut(auth);
    
    showToast('Admin created successfully. Please log back in to continue.', 'success');
    closeModal();
    
    // Redirect to login page after a short delay
    setTimeout(() => {
      window.location.href = 'admin.html';
    }, 2000);
    
  } catch (error) {
    console.error('Error creating admin:', error);
    let errorMessage = 'Error creating admin: ';
    
    // Handle specific Firebase Auth errors
    switch (error.code) {
      case 'auth/email-already-in-use':
        errorMessage += 'Email is already registered';
        break;
      case 'auth/invalid-email':
        errorMessage += 'Invalid email address';
        break;
      case 'auth/weak-password':
        errorMessage += 'Password is too weak';
        break;
      case 'auth/operation-not-allowed':
        errorMessage += 'Email/password accounts are not enabled';
        break;
      default:
        errorMessage += error.message;
    }
    
    showToast(errorMessage, 'error');
  }
}

function editAdmin(adminUid) {
  const admin = allAdminsData.find(a => a.uid === adminUid);
  if (!admin) return;
  
  const modalContent = `
    <div class="modal-header">
      <h3>Edit Admin</h3>
      <button onclick="closeModal()" class="action-btn view-btn" style="border:none;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div><span class="label">Email</span><input type="email" id="edit-admin-email" value="${admin.email || ''}" readonly style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:#f5f5f5;"></div>
        <div><span class="label">Role</span>
          <select id="edit-admin-role" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;">
            <option value="Admin" ${admin.role === 'Admin' ? 'selected' : ''}>Admin</option>
            <option value="HOD" ${admin.role === 'HOD' ? 'selected' : ''}>Head of Department</option>
            <option value="Exam Officer" ${admin.role === 'Exam Officer' ? 'selected' : ''}>Exam Officer</option>
            <option value="Dean" ${admin.role === 'Dean' ? 'selected' : ''}>Dean</option>
            <option value="Registrar" ${admin.role === 'Registrar' ? 'selected' : ''}>Registrar</option>
          </select>
        </div>
        <div><span class="label">Status</span>
          <select id="edit-admin-status" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;">
            <option value="true" ${admin.isAdmin ? 'selected' : ''}>Active</option>
            <option value="false" ${!admin.isAdmin ? 'selected' : ''}>Inactive</option>
          </select>
        </div>
      </div>
      <div style="margin-top:20px;">
        <button class="action-btn in-progress-btn" onclick="updateAdmin('${adminUid}')">Update Admin</button>
        <button class="action-btn view-btn" onclick="closeModal()" style="margin-left:10px;">Cancel</button>
      </div>
    </div>
  `;
  openModal(modalContent);
}

async function updateAdmin(adminUid) {
  const role = document.getElementById('edit-admin-role').value;
  const isAdmin = document.getElementById('edit-admin-status').value === 'true';
  
  try {
    await update(ref(db, `admins/${adminUid}`), {
      role: role,
      isAdmin: isAdmin,
      updatedAt: new Date().toISOString(),
      updatedBy: auth.currentUser.uid
    });
    
    showToast('Admin updated successfully', 'success');
    closeModal();
    
  } catch (error) {
    console.error('Error updating admin:', error);
    showToast('Error updating admin: ' + error.message, 'error');
  }
}

async function deleteAdmin(adminUid) {
  if (!confirm('Are you sure you want to delete this admin? This action cannot be undone.')) {
    return;
  }
  
  try {
    await update(ref(db), { [`admins/${adminUid}`]: null });
    showToast('Admin deleted successfully', 'success');
    
  } catch (error) {
    console.error('Error deleting admin:', error);
    showToast('Error deleting admin: ' + error.message, 'error');
  }
}

// Make functions globally available
window.editAdmin = editAdmin;
window.deleteAdmin = deleteAdmin;
window.createAdmin = createAdmin;
window.updateAdmin = updateAdmin;

</script>
</body>
</html>