<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <link rel="icon" type="image/x-icon" href="gctu.ico" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Admin Dashboard - QUEUEUP</title>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <style>
  :root {
    --primary-color: #007bff;
    --info-color: #17a2b8;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --bg: #f8f9fa;
    --card: #ffffff;
    --muted: #6c757d;
    --border: #e9ecef;
    --shadow: rgba(0,0,0,0.05);
  }
  body.dark-mode {
    --primary-color: #90caf9;
    --info-color: #4dd0e1;
    --success-color: #66bb6a;
    --danger-color: #ef5350;
    --bg: #181a1b;
    --card: #23272b;
    --muted: #b0b3b8;
    --border: #33383d;
    --shadow: rgba(0,0,0,0.4);
    color: #e0e0e0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.2s, color 0.2s, box-shadow 0.2s, border 0.2s; }

  body {
    font-family: "Poppins", sans-serif;
  padding: 0;
    background: var(--bg);
    color: #222;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    width: 100%;
    max-width: 1200px;
    margin: 18px auto;
    padding: 18px;
    border-radius: 18px;
    background: #fff;
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
  }

  /* Navbar */
  .navbar {
  position: sticky;
  top: 0;
  z-index: 1000;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--card);
  padding: 12px 18px;
  border-radius: 16px;
  box-shadow: 0 8px 32px var(--shadow);
  margin-bottom: 12px;
  gap: 12px;
  }

  .navbar-brand {
    display: flex;
    align-items: center;
    margin-right: auto;
  }

  .logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
  }

  .brand-text {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary-color);
  }

  #logout-btn {
    background: var(--primary-color);
    color: #fff;
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s ease;
    margin-left: auto;
  }
  #logout-btn:hover { background: #0056b3; }

  /* Tabs */
  .nav-tabs {
    display: flex;
    gap: 8px;
    margin: 16px 0;
    flex-wrap: wrap;
  }
  .nav-tab {
    padding: 10px 18px;
    border-radius: 10px 10px 0 0;
    cursor: pointer;
    background: transparent;
    border-bottom: 3px solid transparent;
    color: var(--muted);
    font-weight: 500;
    outline: none;
  }
  .nav-tab:focus {
    box-shadow: 0 0 0 2px var(--primary-color);
  }
  .nav-tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: rgba(0,0,0,0.04);
    font-weight: 700;
  }

  /* Dashboard grid */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 18px;
  }

  .card {
    background: var(--card);
    border-radius: 16px;
    padding: 22px 18px 18px 18px;
    box-shadow: 0 8px 32px var(--shadow);
    margin-bottom: 12px;
  }

  .metric-card .value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-color);
  }

  .chart-container { height: 340px; }

  /* Lists */
  .list-container { padding: 12px; }
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .list-header input,
  .list-header select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  table.list-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  table.list-table th,
  table.list-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }

  /* Buttons */
  .action-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .action-btn:focus {
    box-shadow: 0 0 0 2px var(--primary-color);
  }
  .done-btn { background: var(--success-color); color: #fff; }
  .done-btn:hover { background: #218838; }
  .in-progress-btn { background: var(--primary-color); color: #fff; }
  .in-progress-btn:hover { background: #0056b3; }
  .escalate-btn { background: var(--danger-color); color: #fff; }
  .escalate-btn:hover { background: #b71c1c; }
  .view-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); }
  .view-btn:hover { background: var(--bg); color: var(--primary-color); border-color: var(--primary-color); }

  /* Modal */
  .modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal {
    width: 100%;
    max-width: 820px;
    background: #fff;
    padding: 24px 18px 18px 18px;
    border-radius: 18px;
    max-height: 85vh;
    overflow: auto;
    margin: auto;
    position: relative;
    top: 10vh;
    box-shadow: 0 8px 32px var(--shadow);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
  }

  /* Status badges (consistent naming) */
  .status-badge {
    padding: 6px 14px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 13px;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    letter-spacing: 0.5px;
  }
  .s-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
  .s-inprogress { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  .s-resolved { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

  .search-input { width: 320px; max-width: 100%; border: 1.5px solid var(--border); transition: border 0.2s; }
  .search-input:focus { border: 1.5px solid var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
  .small-muted { color: var(--muted); font-size: 13px; letter-spacing: 0.2px; }

  @media (max-width: 900px) {
    .chart-container { height: 240px; }
    .list-container { overflow-x: auto; }
  }
</style>

</head>
<body>
Â  <div class="container">
Â  Â  <div class="navbar">
 Â  Â  Â <div class="navbar-brand">
 Â  Â  Â  Â <img src="gctu.png" class="logo" alt="logo">
 Â  Â  Â  Â <div>
 Â  Â  Â  Â  Â <div style="font-weight:700">QUEUEUP Admin</div>
 Â  Â  Â  Â  Â <div style="font-size:13px; color:var(--muted)">GCTU</div>
 Â  Â  Â  Â </div>
 Â  Â  Â </div>
 Â  Â  Â <div style="display:flex; align-items:center; gap:10px;">
 Â  Â  Â  Â <button id="dark-mode-toggle" class="action-btn view-btn" title="Toggle dark mode" aria-label="Toggle dark mode">ðŸŒ™</button>
 Â  Â  Â  Â <button id="logout-btn" class="action-btn in-progress-btn">Log out</button>
 Â  Â  Â </div>
Â  Â  </div>
Â  Â  <div class="nav-tabs" role="tablist">
  <span class="nav-tab active" data-tab="dashboard">Dashboard Overview</span>
  <span class="nav-tab" data-tab="users">User Management</span>
  <span class="nav-tab" data-tab="complaints">Complaints</span>
  <span class="nav-tab" data-tab="result_issues">Result Issues</span>
Â  Â  </div>

Â  Â  <div id="dashboard-content">
      <div class="dashboard-grid">
        <div class="card metric-card">
          <h3>Total Users</h3>
          <div id="total-users" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Queue Now</h3>
          <div id="queue-now" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Pending Complaints</h3>
          <div id="pending-complaints" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Unresolved Result Issues</h3>
          <div id="unresolved-result-issues" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Completed Queues</h3>
          <div id="completed-queues" class="value">0</div>
        </div>
        <div class="card metric-card">
          <h3>Active Users Online</h3>
          <div id="active-users" class="value">N/A</div>
        </div>
        <div class="card" style="grid-column:1 / -1">
          <h3>Recent Activity</h3>
          <div class="activity-log" style="height:160px; overflow:auto; padding-top:8px">
            <ul id="activity-log-list" style="list-style:none; padding:0; margin:0">
              <li class="small-muted">No recent activity.</li>
            </ul>
          </div>
        </div>
      </div>
Â  Â  </div>



Â  Â  <div id="user-management-content" style="display:none;">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="list-header">
Â  Â  Â  Â  Â  <h3>All Users <span id="user-count" class="small-muted"></span></h3>
Â  Â  Â  Â  Â  <input class="search-input" id="user-search" placeholder="Search by name or ID...">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top:12px; overflow:auto">
Â  Â  Â  Â  Â  <table class="list-table">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="name">Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="studentID">Student ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="role">Role</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th data-sort="joinDate">Join Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="user-table-body"><tr><td colspan="5" class="small-muted">Loading users...</td></tr></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="complaints-content" style="display:none;">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="list-header">
Â  Â  Â  Â  Â  <h3>All Complaints <span id="complaints-count" class="small-muted"></span></h3>
Â  Â  Â  Â  Â  <div style="display:flex; gap:8px">
Â  Â  Â  Â  Â  Â  <input class="search-input" id="complaints-search" placeholder="Search subject or student id...">
Â  Â  Â  Â  Â  Â  <select id="complaints-filter"><option value="all">All</option><option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px; overflow:auto">
Â  Â  Â  Â  Â  <table class="list-table" id="complaints-table">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Subject</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Student</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Type</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="complaints-table-body"><tr><td colspan="6" class="small-muted">Loading complaints...</td></tr></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="result_issues-content" style="display:none;">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="list-header">
Â  Â  Â  Â  Â  <h3>All Result Issues <span id="result-issues-count" class="small-muted"></span></h3>
Â  Â  Â  Â  Â  <div style="display:flex; gap:8px">
Â  Â  Â  Â  Â  Â  <input class="search-input" id="result-search" placeholder="Search course or student id...">
Â  Â  Â  Â  Â  Â  <select id="result-filter"><option value="all">All</option><option value="Queued">Queued</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px; overflow:auto">
Â  Â  Â  Â  Â  <table class="list-table" id="result-table">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Course</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Student</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Issue</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="result-table-body"><tr><td colspan="6" class="small-muted">Loading result issues...</td></tr></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="modalBackdrop" class="modal-backdrop" style="display:none;">
Â  Â  <div class="modal" role="dialog" aria-modal="true">
Â  Â  Â  <div class="modal-content"></div>
Â  Â  </div>
Â  </div>

Â  <script type="module">

 Â  Â // Dark mode toggle logic
 Â  Â const darkModeToggle = document.getElementById('dark-mode-toggle');
 Â  Â function setDarkMode(enabled) {
 Â  Â  Â if (enabled) {
 Â  Â  Â  Â document.body.classList.add('dark-mode');
 Â  Â  Â  Â localStorage.setItem('darkMode', '1');
 Â  Â  Â  Â darkModeToggle.textContent = 'â˜€ï¸';
 Â  Â  Â  Â darkModeToggle.setAttribute('aria-label', 'Switch to light mode');
 Â  Â  Â } else {
 Â  Â  Â  Â document.body.classList.remove('dark-mode');
 Â  Â  Â  Â localStorage.setItem('darkMode', '0');
 Â  Â  Â  Â darkModeToggle.textContent = 'ðŸŒ™';
 Â  Â  Â  Â darkModeToggle.setAttribute('aria-label', 'Switch to dark mode');
 Â  Â  Â }
 Â  Â }
 Â  Â darkModeToggle.addEventListener('click', () => {
 Â  Â  Â setDarkMode(!document.body.classList.contains('dark-mode'));
 Â  Â });
 Â  Â // On load, set mode from localStorage
 Â  Â if (localStorage.getItem('darkMode') === '1') {
 Â  Â  Â setDarkMode(true);
 Â  Â }
 Â  Â else {
 Â  Â  Â setDarkMode(false);
 Â  Â }
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
Â  Â  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
Â  Â  import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

Â  Â  // ---------- CONFIG ----------
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyDIqR0b9hA9IaLhRsVtJKSSwh9NktuIIjI",
Â  Â  Â  authDomain: "queueup-85662.firebaseapp.com",
Â  Â  Â  databaseURL: "https://queueup-85662-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "queueup-85662",
Â  Â  Â  storageBucket: "queueup-85662.firebasestorage.app",
Â  Â  Â  messagingSenderId: "647901471109",
Â  Â  Â  appId: "1:647901471109:web:2607f4883cd1393259e4ec"
Â  Â  };
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const auth = getAuth(app);
Â  Â  const db = getDatabase(app);

Â  Â  // ---------- UI refs ----------
Â  Â  const tabs = document.querySelectorAll('.nav-tab');
Â  Â  const dashboardContent = document.getElementById('dashboard-content');
  // const queueContent = document.getElementById('queue-content');
Â  Â  const userManagementContent = document.getElementById('user-management-content');
Â  Â  const complaintsContent = document.getElementById('complaints-content');
Â  Â  const resultIssuesContent = document.getElementById('result_issues-content');

Â  Â  const logoutBtn = document.getElementById('logout-btn');

Â  Â  // Dashboard elements
Â  Â  const totalUsersEl = document.getElementById('total-users');
Â  Â  const queueNowEl = document.getElementById('queue-now');
Â  Â  const pendingComplaintsEl = document.getElementById('pending-complaints');
Â  Â  const unresolvedResultIssuesEl = document.getElementById('unresolved-result-issues');
Â  Â  const completedQueuesEl = document.getElementById('completed-queues');
Â  Â  const activeUsersEl = document.getElementById('active-users');

Â  Â  // Queue
  // const queueList = document.getElementById('queue-list');
  // const queueSearchInput = document.getElementById('queue-search');

Â  Â  // Users
Â  Â  const userSearchInput = document.getElementById('user-search');
Â  Â  const userTableBody = document.getElementById('user-table-body');

Â  Â  // Complaints
Â  Â  const complaintsTableBody = document.getElementById('complaints-table-body');
Â  Â  const complaintsSearchInput = document.getElementById('complaints-search');
Â  Â  const complaintsFilterSelect = document.getElementById('complaints-filter');
Â  Â  const complaintsCountEl = document.getElementById('complaints-count');

Â  Â  // Result issues
Â  Â  const resultTableBody = document.getElementById('result-table-body');
Â  Â  const resultSearchInput = document.getElementById('result-search');
Â  Â  const resultFilterSelect = document.getElementById('result-filter');
Â  Â  const resultCountEl = document.getElementById('result-issues-count');

Â  Â  // Modals
Â  Â  const modal = document.getElementById('modal');
Â  Â  const modalInnerContent = document.getElementById('modal-inner-content');

Â  Â  // Charts global (declare once)
  let queueSpeedChart = null, rolesDistributionChart = null;

Â  Â  // Local cache
Â  Â  let allUsersData = []; // array of {uid, ...}
Â  Â  let allQueueData = [];
Â  Â  let allComplaintsData = [];
Â  Â  let allResultIssuesData = [];
Â  Â  let allCompletedQueueData = [];
let combinedQueueData = [];

Â  Â  // ---------- Auth & init ----------
Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  if (!user) {
Â  Â  Â  Â  console.warn('[ADMIN DEBUG] No user found, redirecting to admin.html');
Â  Â  Â  Â  window.location.href = 'admin.html';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  console.log('[ADMIN DEBUG] Logged in user:', user.uid);
Â  Â  Â  get(ref(db, `admins/${user.uid}/isAdmin`)).then(snap => {
Â  Â  Â  Â  console.log('[ADMIN DEBUG] isAdmin snap.exists:', snap.exists(), 'snap.val:', snap.val());
Â  Â  Â  Â  if (!snap.exists() || snap.val() !== true) {
Â  Â  Â  Â  Â  console.warn('[ADMIN DEBUG] Not admin or isAdmin not true, signing out in 5 seconds.');
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  window.location.href = 'admin.html';
Â  Â  Â  Â  Â  }, 5000);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.log('[ADMIN DEBUG] Admin check passed, initializing dashboard.');
Â  Â  Â  Â  Â  initDashboard();
Â  Â  Â  Â  Â  initUserManagement();
Â  Â  Â  Â  Â  initComplaints();
Â  Â  Â  Â  Â  initResultIssues();
Â  Â  Â  Â  }
Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  console.error('[ADMIN DEBUG] admin check error', err, 'Signing out in 5 seconds.');
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  window.location.href = 'admin.html';
Â  Â  Â  Â  }, 5000);
Â  Â  Â  });
Â  Â  });

Â  Â  // Logout
Â  Â  logoutBtn.addEventListener('click', () => {
Â  Â  Â  signOut(auth).then(() => window.location.href = 'admin.html').catch(console.error);
Â  Â  });

Â  Â  // Tabs behavior
Â  Â  tabs.forEach(tab => tab.addEventListener('click', () => {
Â  Â  Â  tabs.forEach(t => t.classList.remove('active'));
Â  Â  Â  tab.classList.add('active');
Â  Â  Â  // hide all

  dashboardContent.style.display = 'none';
  userManagementContent.style.display = 'none';
  complaintsContent.style.display = 'none';
  resultIssuesContent.style.display = 'none';

Â  Â  Â  const tabName = tab.dataset.tab;
  if (tabName === 'dashboard') { dashboardContent.style.display = 'block'; initCharts(); }
  if (tabName === 'users') { userManagementContent.style.display = 'block'; renderUsers(allUsersData); }
  if (tabName === 'complaints') { complaintsContent.style.display = 'block'; renderComplaints(allComplaintsData); }
  if (tabName === 'result_issues') { resultIssuesContent.style.display = 'block'; renderResultIssues(allResultIssuesData); }
Â  Â  }));

// ---------- Dashboard & charts ----------
function initDashboard() {
  // Users
  onValue(ref(db, 'users'), (snap) => {
    const users = snap.val() || {};
    allUsersData = Object.entries(users).map(([uid, v]) => ({ uid, ...v }));
    totalUsersEl.textContent = allUsersData.length;
    // updateRolesDistribution removed (no longer needed)
  });

    // Queue (show number of unresolved complaints and result issues as 'queue now')
    const unresolvedComplaints = allComplaintsData.filter(c => c.status === 'pending' || c.status === 'Queued').length;
    const unresolvedResults = allResultIssuesData.filter(c => c.status === 'Queued' || c.status === 'in_progress').length;
    queueNowEl.textContent = unresolvedComplaints + unresolvedResults;

  // Complaints
  onValue(ref(db, 'complaints'), (snap) => {
    const complaints = snap.val() || {};
    allComplaintsData = Object.entries(complaints).map(([id, v]) => ({ id, ...v }));
    const pendingCount = allComplaintsData.filter(c => c.status === 'pending' || c.status === 'Queued').length;
    pendingComplaintsEl.textContent = pendingCount;
    complaintsCountEl.textContent = `(${allComplaintsData.length})`;

  });

  // Completed Queue
  onValue(ref(db, 'completed_queue'), (snap) => {
    const completed = snap.val() || {};
    allCompletedQueueData = Object.entries(completed).map(([id, v]) => ({ id, ...v }));
  completedQueuesEl.textContent = Object.keys(completed).length;
  });

  // Result Issues
  onValue(ref(db, 'result_issues'), (snap) => {
    const res = snap.val() || {};
    allResultIssuesData = Object.entries(res).map(([id, v]) => ({ id, ...v }));
    const unresolvedCount = allResultIssuesData.filter(c => c.status === 'Queued' || c.status === 'in_progress').length;
    unresolvedResultIssuesEl.textContent = unresolvedCount;
    resultCountEl.textContent = `(${allResultIssuesData.length})`;
  });

  // No more queue or complaint charts
  setupRealtimeActivityLog();
}


    // No more queue or complaint charts



Â  Â  // activity log & notification-like entries
Â  Â  function addLog(message) {
Â  Â  Â  const list = document.getElementById('activity-log-list');
Â  Â  Â  if (!list) return;
Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  li.className = 'small-muted';
Â  Â  Â  const t = new Date().toLocaleString();
Â  Â  Â  li.innerHTML = `<strong>${message}</strong> <div style="font-size:12px;color:var(--muted)">${t}</div>`;
Â  Â  Â  // append (show all activities, not just complaints)
Â  Â  Â  list.appendChild(li);
Â  Â  Â  // keep max 50
Â  Â  Â  while (list.children.length > 50) list.removeChild(list.firstChild);
Â  Â  }

    function setupRealtimeActivityLog(){
      // Only log new complaints
      onValue(ref(db,'complaints'), (snap) => {
        const obj = snap.val() || {};
        const arr = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
        const oldIds = allComplaintsData.map(x => x.id);
        arr.forEach(item => { if (!oldIds.includes(item.id)) addLog(`New complaint: ${item.subject || item.description || 'Complaint'}`); });
        allComplaintsData = arr;
      });
    }

    // All queue logic removed

Â  Â  // ---------- User management ----------
Â  Â  function initUserManagement(){
Â  Â  Â  onValue(ref(db,'users'), (snap)=> {
Â  Â  Â  Â  const users = snap.val() || {};
Â  Â  Â  Â  allUsersData = Object.entries(users).map(([uid, v]) => ({ uid, ...v }));
Â  Â  Â  Â  renderUsers(allUsersData);
Â  Â  Â  });
Â  Â  Â  userSearchInput.addEventListener('input', ()=> renderUsers(allUsersData));
Â  Â  }

Â  Â  function renderUsers(users){
Â  Â  Â  userTableBody.innerHTML='';
Â  Â  Â  const term = (userSearchInput.value||'').toLowerCase();
Â  Â  Â  const filtered = users.filter(u => {
Â  Â  Â  Â  const name = u.name || u.full_name || '';
Â  Â  Â  Â  const sid = u.studentID || u.studentId || '';
Â  Â  Â  Â  return name.toLowerCase().includes(term) || (sid+'').toLowerCase().includes(term);
Â  Â  Â  });
Â  Â  Â  document.getElementById('user-count').textContent = `(${filtered.length})`;
Â  Â  Â  if (!filtered.length) {
Â  Â  Â  Â  userTableBody.innerHTML = '<tr><td colspan="5" class="small-muted">No users found.</td></tr>'; return;
Â  Â  Â  }
Â  Â  Â  filtered.forEach(u=>{
Â  Â  Â  Â  const join = u.timestamp ? new Date(u.timestamp).toLocaleDateString() : 'N/A';
Â  Â  Â  Â  const name = u.name || u.full_name || 'N/A';
Â  Â  Â  Â  const sid = u.studentID || u.studentId || 'N/A';
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(sid)}</td><td>${escapeHtml(u.role||'Student')}</td><td>${join}</td><td><button class="action-btn view-btn" data-uid="${u.uid}">View</button></td>`;
Â  Â  Â  Â  userTableBody.appendChild(tr);
Â  Â  Â  });
Â  Â  Â  userTableBody.querySelectorAll('.view-btn').forEach(b=> b.addEventListener('click', e=> showStudentProfileModal(e.currentTarget.dataset.uid)));
Â  Â  }

Â  Â // ---------- Complaints management ----------
function initComplaints(){
  onValue(ref(db,'complaints'), (snap) => {
    const obj = snap.val() || {};
    // complaints are already flat
    allComplaintsData = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
    renderComplaints(allComplaintsData);
  });
  complaintsSearchInput.addEventListener('input', ()=> renderComplaints(allComplaintsData));
  complaintsFilterSelect.addEventListener('change', ()=> renderComplaints(allComplaintsData));
}

function renderComplaints(arr){
  const term = (complaintsSearchInput.value||'').toLowerCase();
  const filter = complaintsFilterSelect.value;
  
  // Remove duplicates: keep only one complaint per id, prefer those with a real student_id
  const uniqueMap = {};
  arr.forEach(item => {
    if (!uniqueMap[item.id] || (item.student_id && item.student_id !== 'Unknown')) {
      uniqueMap[item.id] = item;
    }
  });
  const filtered = Object.values(uniqueMap).filter(item => {
    // Optionally, skip items with student_id 'Unknown'
    if (!item.student_id || item.student_id === 'Unknown') return false;
    const subject = (item.subject || item.description || '').toLowerCase();
    const sid = (item.student_id || '').toString().toLowerCase();
    const matches = subject.includes(term) || sid.includes(term);
    const status = (item.status||'').toLowerCase();
    const statusMatch = (filter==='all') || (status === filter) || (filter==='pending' && (status==='pending' || status==='queued'));
    return matches && statusMatch;
  });

  complaintsTableBody.innerHTML='';
  complaintsCountEl.textContent = `(${filtered.length})`;

  if (!filtered.length) {
    complaintsTableBody.innerHTML = '<tr><td colspan="6" class="small-muted">No complaints found.</td></tr>';
    return;
  }

  filtered.sort((a,b)=> (b.date_submitted||0)-(a.date_submitted||0));

  filtered.forEach(c=>{
    const date = c.date_submitted ? new Date(c.date_submitted).toLocaleString() : 'N/A';
    const statusClass = `s-${(c.status||'pending').replace(/\s+/g,'_')}`;
    const stu = c.student_id || 'Unknown';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(c.subject||c.description||'Complaint')}</td>
      <td>${escapeHtml(stu)}</td>
      <td>${escapeHtml(c.type || 'General')}</td>
      <td><span class="status-badge ${statusClass}">${escapeHtml(c.status||'pending')}</span></td>
      <td>${escapeHtml(date)}</td>
      <td>
        <button class="action-btn view-btn">View</button>
        <button class="action-btn in-progress-btn" data-action="in_progress" data-id="${c.id}" data-student="${stu}">In Progress</button>
        <button class="action-btn done-btn" data-action="resolved" data-id="${c.id}" data-student="${stu}">Resolve</button>
        <button class="action-btn escalate-btn" data-action="delete" data-id="${c.id}" data-student="${stu}">Delete</button>
      </td>`;
    // Attach the complaint object to the view button for modal
    tr.querySelector('.view-btn').addEventListener('click', () => showComplaintModal(c));
    complaintsTableBody.appendChild(tr);
  });

  complaintsTableBody.querySelectorAll('.action-btn').forEach(btn=>{
    btn.addEventListener('click',e=>{
      const id = e.currentTarget.dataset.id;
      const action = e.currentTarget.dataset.action;
      const studentId = btn.dataset.student;
      if (action==='view') showComplaintModal(id);
      else if (action==='delete') deleteComplaint(id, studentId);
      else setComplaintStatus(id, studentId, action);
    });
  });
}

function setComplaintStatus(complaintId, studentId, newStatus) {
  // Update flat path
  update(ref(db, `complaints/${complaintId}`), { status: newStatus });
  // Update per-student path
  if (studentId) {
    get(ref(db, `complaints/${studentId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([pushId, obj]) => {
          if (obj && obj.id === complaintId) {
            update(ref(db, `complaints/${studentId}/${pushId}`), { status: newStatus });
          }
        });
      }
    });
  }
}

function deleteComplaint(complaintId, studentId) {
  // Remove from flat path
  update(ref(db), {
    [`complaints/${complaintId}`]: null
  });
  // Remove from per-student path
  if (studentId) {
    get(ref(db, `complaints/${studentId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([pushId, obj]) => {
          if (obj && obj.id === complaintId) {
            update(ref(db), { [`complaints/${studentId}/${pushId}`]: null });
          }
        });
      }
    });
  }
}


Â  Â  // ---------- Result Issues management ----------
function initResultIssues(){
  onValue(ref(db, 'result_issues'), (snap) => {
    const obj = snap.val() || {};
    // already flat
    allResultIssuesData = Object.entries(obj).map(([id, v]) => ({ id, ...v }));
    renderResultIssues(allResultIssuesData);
  });
  resultSearchInput.addEventListener('input', () => renderResultIssues(allResultIssuesData));
  resultFilterSelect.addEventListener('change', () => renderResultIssues(allResultIssuesData));
}

function renderResultIssues(arr){
  const term = (resultSearchInput.value||'').toLowerCase();
  const filter = resultFilterSelect.value;

  const filtered = arr.filter(item => {
    const course = (item.course_code || '').toLowerCase();
    const sid = (item.student_id || '').toLowerCase();
    const matches = course.includes(term) || sid.includes(term);
    const status = (item.status||'').toLowerCase();
    const statusMatch = (filter==='all') || (status === filter);
    return matches && statusMatch;
  });

  resultTableBody.innerHTML = '';
  resultCountEl.textContent = `(${filtered.length})`;

  if (!filtered.length) {
    resultTableBody.innerHTML = '<tr><td colspan="6" class="small-muted">No result issues found.</td></tr>';
    return;
  }

  filtered.sort((a,b)=> (b.date_submitted||0)-(a.date_submitted||0));

  filtered.forEach(issue => {
    const date = issue.date_submitted ? new Date(issue.date_submitted).toLocaleString() : 'N/A';
    const statusClass = `s-${(issue.status||'Queued').replace(/\s+/g,'_')}`;
    const stu = issue.student_id || 'Unknown';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(issue.course_code||'N/A')}</td>
      <td>${escapeHtml(stu)}</td>
      <td>${escapeHtml(issue.description||'N/A')}</td>
      <td><span class="status-badge ${statusClass}">${escapeHtml(issue.status||'Queued')}</span></td>
      <td>${escapeHtml(date)}</td>
      <td>
        <button class="action-btn view-btn">View</button>
        <button class="action-btn in-progress-btn" data-action="in_progress" data-id="${issue.id}" data-student="${stu}">In Progress</button>
        <button class="action-btn done-btn" data-action="resolved" data-id="${issue.id}" data-student="${stu}">Resolve</button>
        <button class="action-btn escalate-btn" data-action="delete" data-id="${issue.id}" data-student="${stu}">Delete</button>
      </td>`;
    tr.querySelector('.view-btn').addEventListener('click', () => showResultIssueModal(issue));
    resultTableBody.appendChild(tr);
  });

  resultTableBody.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id;
      const action = e.currentTarget.dataset.action;
      const studentId = btn.dataset.student;
      if (action === 'view') showResultIssueModal(id);
      else if (action === 'delete') deleteResultIssue(id, studentId);
      else setResultIssueStatus(id, studentId, action);
    });
  });
}

function setResultIssueStatus(issueId, studentId, newStatus) {
  // Update flat path
  update(ref(db, `result_issues/${issueId}`), { status: newStatus });
  // Update per-student path
  if (studentId) {
    get(ref(db, `results_issues/${studentId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([pushId, obj]) => {
          if (obj && obj.id === issueId) {
            update(ref(db, `results_issues/${studentId}/${pushId}`), { status: newStatus });
          }
        });
      }
    });
  }
}

function deleteResultIssue(issueId, studentId) {
  // Remove from flat path
  update(ref(db), {
    [`result_issues/${issueId}`]: null
  });
  // Remove from per-student path
  if (studentId) {
    get(ref(db, `results_issues/${studentId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([pushId, obj]) => {
          // Use id field for matching
          if (obj && obj.id === issueId) {
            update(ref(db), { [`results_issues/${studentId}/${pushId}`]: null });
          }
        });
      }
    });
  }
}


Â  Â  // ---------- Modals ----------
Â  Â  function openModal(htmlContent) {
Â  Â  Â  const modalBackdrop = document.getElementById('modalBackdrop');
Â  Â  Â  const modalContent = modalBackdrop.querySelector('.modal-content');
Â  Â  Â  modalContent.innerHTML = htmlContent;
Â  Â  Â  modalBackdrop.style.display = 'flex';
Â  Â  Â  document.body.style.overflow = 'hidden';
Â  Â  Â  modalBackdrop.setAttribute('aria-hidden', 'false');
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  modalBackdrop.addEventListener('click', backdropClickHandler);
Â  Â  Â  }, 50);
Â  Â  }
Â  Â  function backdropClickHandler(e) {
Â  Â  Â  const modalBackdrop = document.getElementById('modalBackdrop');
Â  Â  Â  if (e.target === modalBackdrop) closeModal();
Â  Â  }
Â  Â  function closeModal() {
Â  Â  Â  const modalBackdrop = document.getElementById('modalBackdrop');
Â  Â  Â  const modalContent = modalBackdrop.querySelector('.modal-content');
Â  Â  Â  modalBackdrop.style.display = 'none';
Â  Â  Â  document.body.style.overflow = '';
Â  Â  Â  modalBackdrop.setAttribute('aria-hidden', 'true');
Â  Â  Â  modalContent.innerHTML = '';
Â  Â  Â  modalBackdrop.removeEventListener('click', backdropClickHandler);
Â  Â  }
Â  Â  window.closeModal = closeModal;

Â  Â  function showComplaintModal(complaint) {
Â  Â  Â  const html = `
Â  Â  Â  Â  <header>
Â  Â  Â  Â  Â  <h2>Complaint Details</h2>
Â  Â  Â  Â  Â  <button onclick="closeModal()" class="close-btn">Close</button>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <strong>Student ID:</strong> ${escapeHtml(complaint.student_id)}<br>
Â  Â  Â  Â  Â  <strong>Complaint:</strong> ${escapeHtml(complaint.text)}<br>
Â  Â  Â  Â  Â  <strong>Status:</strong> ${escapeHtml(complaint.status)}<br>
Â  Â  Â  Â  Â  <strong>Date Submitted:</strong> ${complaint.date_submitted ? new Date(complaint.date_submitted).toLocaleString() : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  openModal(html);
Â  Â  }
Â  Â  window.showComplaintModal = showComplaintModal;

Â  Â  function showResultIssueModal(issue) {
Â  Â  Â  const html = `
Â  Â  Â  Â  <header>
Â  Â  Â  Â  Â  <h2>Result Issue Details</h2>
Â  Â  Â  Â  Â  <button onclick="closeModal()" class="close-btn">Close</button>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <strong>Student ID:</strong> ${escapeHtml(issue.student_id)}<br>
Â  Â  Â  Â  Â  <strong>Faculty:</strong> ${escapeHtml(issue.faculty)}<br>
Â  Â  Â  Â  Â  <strong>Course Code:</strong> ${escapeHtml(issue.course_code)}<br>
Â  Â  Â  Â  Â  <strong>Lecturer:</strong> ${escapeHtml(issue.lecturer_name)}<br>
Â  Â  Â  Â  Â  <strong>Description:</strong> ${escapeHtml(issue.description)}<br>
Â  Â  Â  Â  Â  <strong>Status:</strong> ${escapeHtml(issue.status)}<br>
Â  Â  Â  Â  Â  <strong>Date Submitted:</strong> ${issue.date_submitted ? new Date(issue.date_submitted).toLocaleString() : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  openModal(html);
Â  Â  }
Â  Â  window.showResultIssueModal = showResultIssueModal;

Â  Â  function showStudentProfileModal(uid) {
Â  Â  Â  get(ref(db, `users_by_uid/${uid}`)).then(snap => {
Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  openModal('<div style="padding:24px">No profile found for this user.</div>');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const u = snap.val();
Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  <h3>Student Profile</h3>
Â  Â  Â  Â  Â  Â  <button onclick="closeModal()" class="action-btn view-btn">Close</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <strong>Name:</strong> ${escapeHtml(u.full_name || u.name || '')}<br>
Â  Â  Â  Â  Â  Â  <strong>Student ID:</strong> ${escapeHtml(u.studentId || u.studentID || '')}<br>
Â  Â  Â  Â  Â  Â  <strong>Department:</strong> ${escapeHtml(u.department || '')}<br>
Â  Â  Â  Â  Â  Â  <strong>Academic Year:</strong> ${escapeHtml(u.academic_year || '')}<br>
Â  Â  Â  Â  Â  Â  <strong>Semester:</strong> ${escapeHtml(u.semester || '')}<br>
Â  Â  Â  Â  Â  Â  <strong>Email:</strong> ${escapeHtml(u.email || '')}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  openModal(html);
Â  Â  Â  });
Â  Â  }
Â  Â  window.showStudentProfileModal = showStudentProfileModal;

Â  Â  // utility to prevent XSS
Â  Â  function escapeHtml(text) {
Â  Â  Â  if (!text) return '';
Â  Â  Â  return text.replace(/&/g, "&amp;")
Â  Â  Â  Â  Â  Â  Â .replace(/</g, "&lt;")
Â  Â  Â  Â  Â  Â  Â .replace(/>/g, "&gt;")
Â  Â  Â  Â  Â  Â  Â .replace(/"/g, "&quot;")
Â  Â  Â  Â  Â  Â  Â .replace(/'/g, "&#039;");
Â  Â  }

Â  Â  // ---------- Dashboard logic ----------
Â  Â  // ...existing dashboard logic (initDashboard, renderComplaints, renderResultIssues, etc.)

Â  </script>
</body>
</html>